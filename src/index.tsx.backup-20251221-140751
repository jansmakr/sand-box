import { Hono } from 'hono'
import { renderer } from './renderer'
import { cors } from 'hono/cors'
import { serveStatic } from 'hono/cloudflare-workers'
import { getCookie, setCookie } from 'hono/cookie'
import auth, { getUserSession } from './auth'

type Bindings = {
  DB: D1Database
  ADMIN_PASSWORD: string
  KAKAO_REST_API_KEY?: string
  KAKAO_REDIRECT_URI?: string
}

const app = new Hono<{ Bindings: Bindings }>()

const ADMIN_CONFIG = { sessionKey: 'admin_session' }

async function isAdmin(c: any) {
  const sessionId = getCookie(c, ADMIN_CONFIG.sessionKey)
  if (!sessionId) return false
  
  const { DB } = c.env
  const now = new Date().toISOString()
  const result = await DB.prepare(
    'SELECT session_id FROM admin_sessions WHERE session_id = ? AND expires_at > ?'
  ).bind(sessionId, now).first()
  
  return !!result
}

function generateSessionId() {
  return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2)
}

// 데이터베이스 자동 초기화 미들웨어
let dbInitialized = false
app.use('*', async (c, next) => {
  if (!dbInitialized && c.env.DB) {
    try {
      console.log('🔧 자동 데이터베이스 초기화 시작...')
      const { DB } = c.env
      
      // 필수 테이블들 생성
      await DB.prepare(`CREATE TABLE IF NOT EXISTS admin_sessions (session_id TEXT PRIMARY KEY, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, expires_at DATETIME NOT NULL)`).run()
      await DB.prepare(`CREATE TABLE IF NOT EXISTS partners (id TEXT PRIMARY KEY, facility_name TEXT NOT NULL, facility_type TEXT NOT NULL, facility_sido TEXT, facility_sigungu TEXT, facility_address TEXT, manager_name TEXT NOT NULL, manager_phone TEXT NOT NULL, region_key TEXT, is_regional_center INTEGER DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP)`).run()
      await DB.prepare(`CREATE TABLE IF NOT EXISTS family_care (id TEXT PRIMARY KEY, guardian_name TEXT NOT NULL, guardian_phone TEXT NOT NULL, patient_name TEXT NOT NULL, patient_age INTEGER, region TEXT, requirements TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP)`).run()
      await DB.prepare(`CREATE TABLE IF NOT EXISTS regional_centers (id TEXT PRIMARY KEY, region_key TEXT NOT NULL, partner_id TEXT NOT NULL, facility_id INTEGER, facility_name TEXT NOT NULL, facility_type TEXT NOT NULL, manager_name TEXT NOT NULL, manager_phone TEXT NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP)`).run()
      await DB.prepare(`CREATE TABLE IF NOT EXISTS facilities (id INTEGER PRIMARY KEY AUTOINCREMENT, facility_type TEXT NOT NULL, name TEXT NOT NULL, postal_code TEXT, address TEXT NOT NULL, phone TEXT, latitude REAL NOT NULL, longitude REAL NOT NULL, sido TEXT NOT NULL, sigungu TEXT NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP)`).run()
      
      // regional_centers 테이블에 facility_id 컬럼이 없으면 추가
      try {
        await DB.prepare(`ALTER TABLE regional_centers ADD COLUMN facility_id INTEGER`).run()
        console.log('✅ regional_centers 테이블에 facility_id 컬럼 추가됨')
      } catch (error) {
        // 컬럼이 이미 존재하면 에러 무시
        console.log('ℹ️ regional_centers.facility_id 컬럼이 이미 존재합니다')
      }
      
      dbInitialized = true
      console.log('✅ 데이터베이스 자동 초기화 완료')
    } catch (error) {
      console.error('⚠️ 데이터베이스 초기화 경고:', error)
      // 초기화 실패해도 계속 진행 (테이블이 이미 존재할 수 있음)
      dbInitialized = true
    }
  }
  await next()
})

app.use('/api/*', cors())
app.use('/static/*', serveStatic({ root: './public' }))

// 카카오 로그인 라우트 연결
app.route('/api/auth/kakao', auth)

// 디버깅: 환경 변수 확인 엔드포인트
app.get('/api/debug/env', (c) => {
  const kakaoKey = c.env.KAKAO_REST_API_KEY || 'NOT_SET'
  const redirectUri = c.env.KAKAO_REDIRECT_URI || 'NOT_SET'
  const adminPassword = c.env.ADMIN_PASSWORD || 'NOT_SET'
  
  return c.json({
    KAKAO_REST_API_KEY_PREFIX: kakaoKey.substring(0, 10),
    KAKAO_REST_API_KEY_SUFFIX: kakaoKey.substring(kakaoKey.length - 4),
    KAKAO_REST_API_KEY_LENGTH: kakaoKey.length,
    KAKAO_REDIRECT_URI: redirectUri,
    ADMIN_PASSWORD_SET: adminPassword !== 'NOT_SET',
    timestamp: new Date().toISOString()
  })
})

// 디버깅: D1 데이터베이스 테이블 확인 엔드포인트
app.get('/api/debug/tables', async (c) => {
  try {
    const { DB } = c.env
    const result = await DB.prepare("SELECT name FROM sqlite_master WHERE type='table'").all()
    return c.json({
      tables: result.results,
      count: result.results?.length || 0,
      timestamp: new Date().toISOString()
    })
  } catch (error: any) {
    return c.json({
      error: error.message,
      timestamp: new Date().toISOString()
    }, 500)
  }
})

// 디버깅: users 테이블 생성 (관리자 전용)
app.get('/api/debug/create-users-table', async (c) => {
  try {
    const { DB } = c.env
    
    // users 테이블 생성
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        user_type TEXT NOT NULL CHECK(user_type IN ('customer', 'facility')),
        email TEXT UNIQUE NOT NULL,
        password_hash TEXT NOT NULL,
        name TEXT NOT NULL,
        phone TEXT NOT NULL,
        address TEXT,
        facility_id INTEGER,
        business_number TEXT,
        facility_type TEXT CHECK(facility_type IN ('재가복지', '요양원', '주야간보호센터', '요양병원')),
        region_sido TEXT,
        region_sigungu TEXT,
        is_approved INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (facility_id) REFERENCES facilities(id)
      )
    `).run()
    
    // 인덱스 생성
    await DB.prepare("CREATE INDEX IF NOT EXISTS idx_users_email ON users(email)").run()
    await DB.prepare("CREATE INDEX IF NOT EXISTS idx_users_user_type ON users(user_type)").run()
    
    return c.json({
      success: true,
      message: "users table created successfully",
      timestamp: new Date().toISOString()
    })
  } catch (error: any) {
    return c.json({
      success: false,
      error: error.message,
      timestamp: new Date().toISOString()
    }, 500)
  }
})

// SEO 파일 서빙 (robots.txt, sitemap.xml)
app.get('/robots.txt', (c) => {
  const robotsTxt = `# robots.txt for carejoa.kr

# 모든 검색 엔진 허용
User-agent: *
Allow: /

# 크롤링 속도 제한 (초당 1회)
Crawl-delay: 1

# 관리자 페이지 차단
Disallow: /admin
Disallow: /api/admin/*

# 사이트맵 위치
Sitemap: https://carejoa.kr/sitemap.xml

# 주요 검색엔진별 설정
User-agent: Googlebot
Allow: /

User-agent: Yeti
Allow: /

User-agent: Bingbot
Allow: /

User-agent: Slurp
Allow: /`
  return c.text(robotsTxt, 200, {
    'Content-Type': 'text/plain; charset=utf-8'
  })
})

app.get('/sitemap.xml', (c) => {
  const sitemapXml = `<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.sitemaps.org/schemas/sitemap/0.9
        http://www.sitemaps.org/schemas/sitemap/0.9/sitemap.xsd">
  
  <!-- 메인 페이지 -->
  <url>
    <loc>https://carejoa.kr/</loc>
    <lastmod>2025-10-23</lastmod>
    <changefreq>daily</changefreq>
    <priority>1.0</priority>
  </url>
  
  <!-- 요양시설 검색 페이지 -->
  <url>
    <loc>https://carejoa.kr/search</loc>
    <lastmod>2025-10-23</lastmod>
    <changefreq>daily</changefreq>
    <priority>0.9</priority>
  </url>
  
  <!-- 가족간병 등록 페이지 -->
  <url>
    <loc>https://carejoa.kr/family-care-register</loc>
    <lastmod>2025-10-23</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <!-- 파트너 등록 페이지 -->
  <url>
    <loc>https://carejoa.kr/partner-register</loc>
    <lastmod>2025-10-23</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.8</priority>
  </url>
  
  <!-- 지역 파트너 등록 페이지 -->
  <url>
    <loc>https://carejoa.kr/regional-partner-register</loc>
    <lastmod>2025-10-23</lastmod>
    <changefreq>weekly</changefreq>
    <priority>0.7</priority>
  </url>
  
</urlset>`
  return c.text(sitemapXml, 200, {
    'Content-Type': 'application/xml; charset=utf-8'
  })
})

app.use(renderer)

// 메인 페이지 (전체 디자인)
app.get('/', (c) => {
  // 로그인 상태 확인
  const session = getUserSession(c)
  
  // 로그인 버튼 또는 마이페이지 버튼 (큰 글씨, 큰 버튼)
  const authButton = session 
    ? `<a href="/my-page" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-3 rounded-xl text-lg font-bold">
         내 정보
       </a>`
    : `<a href="/login" class="bg-blue-600 text-white hover:bg-blue-700 px-6 py-3 rounded-xl text-lg font-bold">
         로그인
       </a>`
  
  return c.render(
    <div>
      {/* 심플한 헤더 */}
      <header class="bg-white border-b-4 border-blue-500">
        <div class="max-w-6xl mx-auto px-4 py-4">
          <div class="flex justify-between items-center">
            <a href="/" class="flex items-center space-x-3">
              <img 
                src="https://page.gensparksite.com/v1/base64_upload/b39dca8586af1dacd6d8417554313896" 
                alt="케어조아"
                class="h-12 w-auto"
              />
              <h1 class="text-3xl md:text-4xl font-bold text-blue-600">케어조아</h1>
            </a>
            <div class="flex items-center space-x-4">
              {/* Android 앱 다운로드 버튼 */}
              <a href="https://play.google.com/store/apps/details?id=app.netlify.std_care_joa.twa" 
                 target="_blank" rel="noopener noreferrer"
                 class="hidden md:flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-all">
                <span class="text-2xl">📱</span>
                <span class="font-medium">앱 다운</span>
              </a>
              {/* 서비스 소개 링크 (데스크톱) */}
              <a href="/services" class="hidden md:block text-gray-700 hover:text-blue-600 font-medium">
                서비스 소개
              </a>
              <div dangerouslySetInnerHTML={{ __html: authButton }}></div>
            </div>
          </div>
        </div>
      </header>

      {/* 메인 섹션 - 최대한 단순하게 */}
      <section class="bg-gradient-to-b from-blue-50 to-white py-12 md:py-20 pb-24 md:pb-20">
        <div class="max-w-4xl mx-auto px-4 py-8 md:py-16">
          {/* 타이틀 */}
          <div class="text-center mb-12 md:mb-16">
            <h1 class="text-4xl md:text-6xl font-bold text-gray-900 mb-6 leading-tight">
              요양시설 찾기<br />
              <span class="text-blue-600">이제 쉽게!</span>
            </h1>
            <p class="text-xl md:text-2xl text-gray-700 mb-4">
              어르신께 맞는 시설을 빠르게 찾아드립니다
            </p>
          </div>

          {/* 3개의 큰 버튼 */}
          <div class="space-y-6 md:space-y-8 mb-12">
            {/* 1. 요양시설 찾기 */}
            <a href="https://www.carejoa.com" 
               target="_blank" rel="noopener noreferrer"
               class="flex items-center justify-between bg-white hover:bg-blue-50 p-8 md:p-10 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-blue-200 hover:border-blue-400">
              <div class="flex items-center space-x-6">
                <div class="text-6xl md:text-7xl">🏥</div>
                <div class="text-left">
                  <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">요양시설 찾기</h3>
                  <p class="text-base md:text-lg text-gray-600">지역별 시설 비교 및 견적 받기</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-3xl text-blue-500"></i>
            </a>

            {/* 2. 전화 상담 */}
            <button 
               onclick="document.getElementById('regionalCallModal').classList.remove('hidden')"
               class="flex items-center justify-between w-full bg-white hover:bg-green-50 p-8 md:p-10 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-green-200 hover:border-green-400">
              <div class="flex items-center space-x-6">
                <div class="text-6xl md:text-7xl">📞</div>
                <div class="text-left">
                  <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">전화 상담</h3>
                  <p class="text-base md:text-lg text-gray-600">지역별 전문 상담사와 통화</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-3xl text-green-500"></i>
            </button>

            {/* 3. 카카오톡 상담 */}
            <a href="https://open.kakao.com/o/siR7YBUh" 
               target="_blank" rel="noopener noreferrer"
               class="flex items-center justify-between bg-white hover:bg-yellow-50 p-8 md:p-10 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 border-2 border-yellow-200 hover:border-yellow-400">
              <div class="flex items-center space-x-6">
                <div class="text-6xl md:text-7xl">💬</div>
                <div class="text-left">
                  <h3 class="text-2xl md:text-3xl font-bold text-gray-900 mb-2">카카오톡 상담</h3>
                  <p class="text-base md:text-lg text-gray-600">편하게 채팅으로 문의하기</p>
                </div>
              </div>
              <i class="fas fa-chevron-right text-3xl text-yellow-500"></i>
            </a>
          </div>

          {/* 간단한 통계 */}
          <div class="bg-white rounded-2xl p-6 md:p-8 shadow-lg">
            <div class="grid grid-cols-3 gap-4 md:gap-8 text-center">
              <div>
                <div class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">10만+</div>
                <div class="text-sm md:text-base text-gray-600">이용자</div>
              </div>
              <div>
                <div class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">3,000+</div>
                <div class="text-sm md:text-base text-gray-600">등록시설</div>
              </div>
              <div>
                <div class="text-3xl md:text-4xl font-bold text-blue-600 mb-2">4.5★</div>
                <div class="text-sm md:text-base text-gray-600">만족도</div>
              </div>
            </div>
          </div>

          {/* 서비스 소개 링크 */}
          <div class="text-center mt-12">
            <a href="/services" class="inline-block text-lg text-blue-600 hover:text-blue-700 font-medium">
              더 자세한 서비스 소개 보기 →
            </a>
          </div>
        </div>
      </section>

      {/* 모바일 하단 네비게이션 */}
      <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 shadow-lg z-50 md:hidden" style="padding-bottom: env(safe-area-inset-bottom);">
        <div class="flex justify-around items-center py-2 px-1">
          <a href="https://www.carejoa.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center py-2 px-2 hover:bg-gray-50 rounded-lg transition-colors min-w-0 flex-1">
            <div class="text-xl mb-1">📋</div>
            <span class="text-[9px] text-gray-700 font-medium whitespace-nowrap">견적상담</span>
          </a>
          <button onclick="document.getElementById('regionalCallModal').classList.remove('hidden')" class="flex flex-col items-center py-2 px-2 hover:bg-gray-50 rounded-lg transition-colors min-w-0 flex-1">
            <div class="text-xl mb-1">📞</div>
            <span class="text-[9px] text-gray-700 font-medium whitespace-nowrap">전화상담</span>
          </button>
          <a href="https://open.kakao.com/o/siR7YBUh" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center py-2 px-2 hover:bg-gray-50 rounded-lg transition-colors min-w-0 flex-1">
            <div class="text-xl mb-1">💬</div>
            <span class="text-[9px] text-gray-700 font-medium whitespace-nowrap">채팅문의</span>
          </a>
          <a href="https://www.carejoa.com" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center py-2 px-2 hover:bg-gray-50 rounded-lg transition-colors min-w-0 flex-1">
            <div class="text-xl mb-1">👤</div>
            <span class="text-[9px] text-gray-700 font-medium whitespace-nowrap">마이페이지</span>
          </a>
        </div>
      </div>

      {/* 지역별 전화상담 모달 */}
      <div id="regionalCallModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-gradient-to-r from-green-500 to-emerald-500 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-bold">
                <i class="fas fa-phone-alt mr-2"></i>지역별 전화상담
              </h3>
              <button onclick="document.getElementById('regionalCallModal').classList.add('hidden')" 
                      class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
            <div class="text-center p-6 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl">
              <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-calculator text-2xl text-white"></i>
              </div>
              <h4 class="text-xl font-bold mb-2">실시간 견적</h4>
              <p class="text-gray-600 text-sm">간단한 정보 입력으로 맞춤형 견적을 즉시 확인</p>
            </div>
            
            <div class="text-center p-6 bg-gradient-to-br from-green-50 to-green-100 rounded-xl">
              <div class="w-16 h-16 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-shield-check text-2xl text-white"></i>
              </div>
              <h4 class="text-xl font-bold mb-2">검증된 시설</h4>
              <p class="text-gray-600 text-sm">정부 인증 및 전문가 방문을 통해 검증</p>
            </div>
            
            <div class="text-center p-6 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl">
              <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-md text-2xl text-white"></i>
              </div>
              <h4 class="text-xl font-bold mb-2">전문 상담</h4>
              <p class="text-gray-600 text-sm">자격을 보유한 전문 상담사가 24시간 상담</p>
            </div>
            
            <div class="text-center p-6 bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl">
              <div class="w-16 h-16 bg-gradient-to-r from-orange-500 to-orange-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-heart text-2xl text-white"></i>
              </div>
              <h4 class="text-xl font-bold mb-2">가족 같은 마음</h4>
              <p class="text-gray-600 text-sm">믿을 수 있는 곳을 찾기까지 끝까지 함께</p>
            </div>
          </div>
        </div>
      </section>

      {/* 3단계 프로세스 */}
      <section class="py-20 bg-gray-50">
        <div class="max-w-7xl mx-auto px-4">
          <div class="text-center mb-16">
            <h3 class="text-3xl font-bold text-gray-900 mb-4">
              간단한 3단계로 <span class="text-teal-600">완료!</span>
            </h3>
          </div>
          
          <div class="grid md:grid-cols-3 gap-8">
            <div class="text-center relative">
              <div class="w-20 h-20 bg-gradient-to-r from-blue-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-2xl font-bold text-white">1</span>
              </div>
              <h4 class="text-xl font-bold mb-4">정보 입력</h4>
              <p class="text-gray-600">어르신의 기본 정보와 필요한 서비스를 입력</p>
            </div>
            
            <div class="text-center relative">
              <div class="w-20 h-20 bg-gradient-to-r from-green-500 to-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-2xl font-bold text-white">2</span>
              </div>
              <h4 class="text-xl font-bold mb-4">견적 비교</h4>
              <p class="text-gray-600">실시간으로 매칭된 시설들을 비교</p>
            </div>
            
            <div class="text-center">
              <div class="w-20 h-20 bg-gradient-to-r from-purple-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <span class="text-2xl font-bold text-white">3</span>
              </div>
              <h4 class="text-xl font-bold mb-4">전문 상담</h4>
              <p class="text-gray-600">전문 상담사와 1:1 맞춤 상담</p>
            </div>
          </div>
        </div>
      </section>

      {/* 고객 후기 섹션 */}
      <section class="py-16 md:py-20 bg-white">
        <div class="max-w-7xl mx-auto px-4">
          <div class="text-center mb-12 md:mb-16">
            <div class="inline-block bg-gradient-to-r from-yellow-400 to-orange-500 text-white text-xs md:text-sm font-bold px-4 py-2 rounded-full mb-4">
              ⭐ 실제 이용 고객님들의 생생한 후기
            </div>
            <h3 class="text-2xl md:text-4xl font-bold text-gray-900 mb-4">
              케어조아와 함께한 <span class="text-teal-600">따뜻한 이야기</span>
            </h3>
            <p class="text-sm md:text-lg text-gray-600">
              10만 명 이상의 고객님들이 케어조아를 통해 최적의 요양시설을 찾으셨습니다
            </p>
          </div>

          <div class="grid md:grid-cols-3 gap-6 md:gap-8">
            {/* 후기 1 */}
            <div class="bg-gradient-to-br from-blue-50 to-white rounded-2xl p-6 md:p-8 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
              <div class="flex items-center mb-4">
                <div class="flex text-yellow-400 text-xl md:text-2xl">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                </div>
                <span class="ml-2 text-sm md:text-base font-bold text-gray-700">5.0</span>
              </div>
              
              <p class="text-sm md:text-base text-gray-700 leading-relaxed mb-6">
                "어머니께 맞는 요양원을 찾느라 몇 달을 고민했는데, 케어조아 덕분에 단 3일 만에 완벽한 곳을 찾았습니다. 
                상담사님이 정말 친절하고 전문적이셨어요. 어머니도 너무 만족하고 계십니다."
              </p>
              
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                  김
                </div>
                <div class="ml-3">
                  <div class="font-bold text-gray-900">김민지 님</div>
                  <div class="text-xs md:text-sm text-gray-500">서울 강남구 · 요양원</div>
                </div>
              </div>
            </div>

            {/* 후기 2 */}
            <div class="bg-gradient-to-br from-green-50 to-white rounded-2xl p-6 md:p-8 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
              <div class="flex items-center mb-4">
                <div class="flex text-yellow-400 text-xl md:text-2xl">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                </div>
                <span class="ml-2 text-sm md:text-base font-bold text-gray-700">5.0</span>
              </div>
              
              <p class="text-sm md:text-base text-gray-700 leading-relaxed mb-6">
                "여러 요양병원을 직접 방문하는 것도 힘들고 비교하기도 어려웠는데, 케어조아에서 한 번에 비교하고 
                견적까지 받을 수 있어서 너무 편했습니다. 시간과 비용을 많이 절약했어요!"
              </p>
              
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                  이
                </div>
                <div class="ml-3">
                  <div class="font-bold text-gray-900">이정훈 님</div>
                  <div class="text-xs md:text-sm text-gray-500">부산 해운대구 · 요양병원</div>
                </div>
              </div>
            </div>

            {/* 후기 3 */}
            <div class="bg-gradient-to-br from-purple-50 to-white rounded-2xl p-6 md:p-8 shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2">
              <div class="flex items-center mb-4">
                <div class="flex text-yellow-400 text-xl md:text-2xl">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                </div>
                <span class="ml-2 text-sm md:text-base font-bold text-gray-700">5.0</span>
              </div>
              
              <p class="text-sm md:text-base text-gray-700 leading-relaxed mb-6">
                "처음에는 온라인으로 이런 중요한 결정을 하는 게 걱정됐는데, 상담사님이 직접 시설을 방문한 경험을 
                바탕으로 상세하게 설명해주셔서 안심이 되었습니다. 정말 감사드립니다."
              </p>
              
              <div class="flex items-center">
                <div class="w-12 h-12 bg-gradient-to-br from-purple-400 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                  박
                </div>
                <div class="ml-3">
                  <div class="font-bold text-gray-900">박수진 님</div>
                  <div class="text-xs md:text-sm text-gray-500">경기 성남시 · 주간보호센터</div>
                </div>
              </div>
            </div>
          </div>

          {/* 통계 요약 */}
          <div class="mt-12 md:mt-16 bg-gradient-to-r from-teal-500 to-emerald-600 rounded-2xl p-6 md:p-10">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 md:gap-8 text-center text-white">
              <div>
                <div class="text-3xl md:text-5xl font-bold mb-2">4.8<span class="text-2xl md:text-3xl">/5.0</span></div>
                <div class="text-xs md:text-sm opacity-90">평균 만족도</div>
              </div>
              <div>
                <div class="text-3xl md:text-5xl font-bold mb-2">10만+</div>
                <div class="text-xs md:text-sm opacity-90">누적 이용자</div>
              </div>
              <div>
                <div class="text-3xl md:text-5xl font-bold mb-2">3,000+</div>
                <div class="text-xs md:text-sm opacity-90">등록 시설</div>
              </div>
              <div>
                <div class="text-3xl md:text-5xl font-bold mb-2">95%</div>
                <div class="text-xs md:text-sm opacity-90">재이용 의향</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      {/* 유튜브 소개 영상 */}
      <section class="py-12 bg-white">
        <div class="max-w-7xl mx-auto px-4">
          <div class="flex justify-center">
            <a href="https://youtu.be/lUQkWC8PRrM?si=l-AOOz72I0z0oWE1" 
               target="_blank" 
               rel="noopener noreferrer"
               class="group relative block rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 w-full max-w-sm">
              <img 
                src="https://img.youtube.com/vi/lUQkWC8PRrM/hqdefault.jpg" 
                alt="케어조아 소개 영상"
                class="w-full h-auto"
              />
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all duration-300 flex items-center justify-center">
                <div class="w-16 h-16 bg-red-600 rounded-full flex items-center justify-center opacity-90 group-hover:opacity-100 transition-opacity">
                  <i class="fas fa-play text-white text-2xl ml-1"></i>
                </div>
              </div>
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-4">
                <p class="text-white text-sm font-semibold">
                  <i class="fab fa-youtube text-red-500 mr-2"></i>케어조아 소개 영상 보기
                </p>
              </div>
            </a>
          </div>
        </div>
      </section>

      {/* 요양시설 입점 섹션 */}
      <section id="partner-section" class="py-20 bg-gradient-to-br from-teal-50 to-emerald-50">
        <div class="max-w-7xl mx-auto px-4">
          <div class="text-center mb-12">
            <h3 class="text-3xl font-bold text-gray-900 mb-4">
              <i class="fas fa-handshake text-teal-600 mr-3"></i>요양시설 및 관련기관 입점신청
            </h3>
            <p class="text-lg text-gray-600">케어조아와 함께 더 많은 고객을 만나보세요</p>
          </div>
          
          <div class="bg-white p-8 rounded-2xl shadow-lg max-w-4xl mx-auto">
            <form id="partnerForm" class="space-y-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-building mr-1 text-blue-500"></i>시설명*
                  </label>
                  <input type="text" id="facilityName" required 
                    class="w-full p-3 border rounded-lg"
                    placeholder="시설/서비스명" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-tag mr-1 text-purple-500"></i>시설 유형*
                  </label>
                  <select id="facilityType" required class="w-full p-3 border rounded-lg">
                    <option value="">선택하세요</option>
                    <option value="상급 및 종합병원">상급 및 종합병원</option>
                    <option value="주민센터사회복지">주민센터사회복지</option>
                    <option value="요양원">요양원</option>
                    <option value="요양병원">요양병원</option>
                    <option value="주간보호센터">주간보호센터</option>
                    <option value="그룹홈">그룹홈</option>
                    <option value="재가복지센터">재가복지센터</option>
                    <option value="한의사왕진서비스">한의사왕진서비스</option>
                    <option value="기타">기타</option>
                  </select>
                </div>
              </div>
              
              {/* 주소 입력 */}
              <div class="border-t pt-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">
                  <i class="fas fa-map-marker-alt mr-2 text-red-500"></i>시설 주소
                </h4>
                <div class="grid md:grid-cols-2 gap-6 mb-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-map mr-1 text-blue-500"></i>시/도*
                    </label>
                    <select id="facilitySido" required class="w-full p-3 border rounded-lg">
                      <option value="">시/도를 선택하세요</option>
                    </select>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                      <i class="fas fa-map-marker mr-1 text-green-500"></i>시/군/구*
                    </label>
                    <select id="facilitySigungu" required class="w-full p-3 border rounded-lg" disabled>
                      <option value="">시/군/구를 선택하세요</option>
                    </select>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-home mr-1 text-purple-500"></i>상세주소*
                  </label>
                  <input type="text" id="facilityAddress" required 
                    class="w-full p-3 border rounded-lg" 
                    placeholder="예: 강남대로 123, 케어빌딩 2층" />
                </div>
              </div>
              
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1 text-green-500"></i>담당자명*
                  </label>
                  <input type="text" id="managerName" required class="w-full p-3 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-phone mr-1 text-purple-500"></i>연락처*
                  </label>
                  <input type="tel" id="managerPhone" required class="w-full p-3 border rounded-lg" placeholder="010-0000-0000" />
                </div>
              </div>
              
              <div class="text-center pt-6">
                <button type="submit" class="bg-gradient-to-r from-teal-600 to-emerald-600 text-white px-12 py-4 rounded-lg hover:from-teal-700 hover:to-emerald-700 transform hover:scale-105 font-bold">
                  <i class="fas fa-handshake mr-2"></i>요양시설 및 관련기관 입점신청
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      {/* 푸터 */}
      <footer class="bg-gray-900 text-white py-12">
        <div class="max-w-7xl mx-auto px-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            <div>
              <h4 class="text-lg font-bold mb-4 flex items-center">
                <i class="fas fa-heart mr-2 text-teal-400"></i>케어조아
              </h4>
              <p class="text-gray-400 text-sm">내 집처럼 편안한 곳, 내 가족처럼 믿을 수 있는 곳</p>
            </div>
            
            <div>
              <h5 class="font-semibold mb-4">서비스</h5>
              <ul class="space-y-2 text-sm text-gray-400">
                <li>실시간 견적</li>
                <li>시설 검색</li>
                <li>전문 상담</li>
                <li>파트너 등록</li>
              </ul>
            </div>
            
            <div>
              <h5 class="font-semibold mb-4">고객지원</h5>
              <ul class="space-y-3 text-sm text-gray-400">
                <li class="flex items-center">
                  <i class="fas fa-phone mr-2 text-teal-400"></i>
                  <a href="tel:07070045902">070-7004-5902</a>
                </li>
                <li>
                  <a href="https://open.kakao.com/o/siR7YBUh" target="_blank" class="flex items-center">
                    <i class="fas fa-comment-dots mr-2 text-yellow-400"></i>카카오톡 상담
                  </a>
                </li>
                <li class="flex items-center">
                  <i class="fas fa-envelope mr-2 text-blue-400"></i>utuber@kakao.com
                </li>
              </ul>
            </div>
            
            <div>
              <h5 class="font-semibold mb-4">앱 다운로드</h5>
              <div class="space-y-3">
                <a href="https://play.google.com/store/apps/details?id=app.netlify.std_care_joa.twa" target="_blank" class="flex items-center text-sm text-gray-400">
                  <i class="fab fa-android mr-2 text-green-400"></i>안드로이드 앱
                </a>
                <a href="https://www.carejoa.com" target="_blank" class="flex items-center text-sm text-gray-400">
                  <i class="fas fa-globe mr-2 text-blue-400"></i>웹 서비스
                </a>
              </div>
            </div>
          </div>
          
          <div class="border-t border-gray-800 mt-8 pt-8 text-center">
            <p class="text-sm text-blue-400 font-medium mb-3">
              <i class="fas fa-certificate mr-1"></i>특허기반 실시간 요양 견적 및 상담 플랫폼
            </p>
            <p class="text-xs text-gray-400 mb-3">© 2025 케어조아. All rights reserved.</p>
            <a href="/admin" class="inline-block text-xs text-gray-500 hover:text-gray-300 transition-colors">
              <i class="fas fa-shield-alt mr-1"></i>관리자 로그인
            </a>
          </div>
        </div>
      </footer>

      {/* 카카오톡 플로팅 버튼 (우측 하단) */}
      <a href="https://open.kakao.com/o/siR7YBUh" 
         target="_blank" 
         rel="noopener noreferrer"
         class="fixed bottom-20 md:bottom-6 right-4 md:right-6 z-40 bg-yellow-400 hover:bg-yellow-500 text-gray-900 w-14 h-14 md:w-16 md:h-16 rounded-full shadow-2xl flex items-center justify-center transition-all duration-300 transform hover:scale-110 group"
         onclick="if(window.trackEvent) trackEvent('kakao_chat_click', {location: 'floating_button'})">
        <i class="fas fa-comment-dots text-2xl md:text-3xl"></i>
        <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full animate-pulse">
          1:1
        </span>
        <div class="absolute bottom-full right-0 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
          카카오톡 상담
          <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
        </div>
      </a>

      {/* 상급 및 병원담당자 모달 */}
      <div id="hospitalManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-gradient-to-r from-red-500 to-rose-500 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-bold">
                <i class="fas fa-hospital mr-2"></i>퇴원 환자 연계, 이제 투명하게
              </h3>
              <button onclick="document.getElementById('hospitalManagerModal').classList.add('hidden')" 
                      class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <p class="text-red-100 mt-2">로비·금품 부담 없는 윤리적 환자 연계 시스템</p>
          </div>

          <div class="p-8 space-y-6">
            {/* 핵심 메시지 */}
            <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
              <h4 class="font-bold text-red-900 mb-2">
                <i class="fas fa-shield-alt mr-2"></i>담당자님의 부담을 덜어드립니다
              </h4>
              <p class="text-red-800 text-sm">케어조아는 병원 담당자와 환자 가족을 직접 연결하는 투명한 플랫폼입니다.</p>
            </div>

            {/* 주요 기능 */}
            <div class="grid md:grid-cols-2 gap-4">
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-check-circle text-red-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">지역별 대표시설 자동 매칭</h5>
                  <p class="text-sm text-gray-600">전국 851개 대표시설과 즉시 연결</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-calculator text-red-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">실시간 견적 비교</h5>
                  <p class="text-sm text-gray-600">환자 가족이 직접 비교하고 선택</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-ban text-red-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">로비·금품 부담 완전 제로</h5>
                  <p class="text-sm text-gray-600">윤리적이고 투명한 연계 시스템</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-users text-red-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">환자 가족 직접 선택</h5>
                  <p class="text-sm text-gray-600">중개자 없는 직접 연결 방식</p>
                </div>
              </div>
            </div>

            {/* 특별고객 등록 폼 */}
            <div class="bg-gradient-to-br from-red-50 to-rose-50 p-6 rounded-xl border-2 border-red-200">
              <h4 class="text-xl font-bold text-red-900 mb-4">
                <i class="fas fa-star mr-2"></i>특별고객 등록
              </h4>
              <form id="hospitalManagerForm" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">병원명 *</label>
                    <input type="text" required class="w-full p-3 border rounded-lg" placeholder="예: 서울대학교병원" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">담당자명 *</label>
                    <input type="text" required class="w-full p-3 border rounded-lg" placeholder="홍길동" />
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">연락처 *</label>
                    <input type="tel" required class="w-full p-3 border rounded-lg" placeholder="010-0000-0000" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">이메일</label>
                    <input type="email" class="w-full p-3 border rounded-lg" placeholder="example@hospital.com" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">문의사항</label>
                  <textarea rows="3" class="w-full p-3 border rounded-lg" placeholder="궁금하신 점을 남겨주세요"></textarea>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-red-700 transition-colors">
                  <i class="fas fa-paper-plane mr-2"></i>특별고객 등록 신청
                </button>
              </form>
            </div>

            {/* 추가 정보 */}
            <div class="text-center text-sm text-gray-500 space-y-2">
              <p><i class="fas fa-phone mr-1"></i>상담문의: 02-6677-4915</p>
              <p><i class="fas fa-comment mr-1"></i>카카오톡 상담: <a href="https://open.kakao.com/o/siR7YBUh" target="_blank" class="text-red-600 hover:underline">바로가기</a></p>
            </div>
          </div>
        </div>
      </div>

      {/* 정부복지담당자 모달 */}
      <div id="govManagerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-indigo-500 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-bold">
                <i class="fas fa-building mr-2"></i>대상자 매칭, 공정하고 투명하게
              </h3>
              <button onclick="document.getElementById('govManagerModal').classList.add('hidden')" 
                      class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <p class="text-blue-100 mt-2">복지 담당자의 부담을 줄이는 스마트 매칭 시스템</p>
          </div>

          <div class="p-8 space-y-6">
            {/* 핵심 메시지 */}
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
              <h4 class="font-bold text-blue-900 mb-2">
                <i class="fas fa-shield-alt mr-2"></i>담당자님의 부담을 덜어드립니다
              </h4>
              <p class="text-blue-800 text-sm">케어조아는 복지 대상자와 시설을 투명하게 연결하는 공정한 플랫폼입니다.</p>
            </div>

            {/* 주요 기능 */}
            <div class="grid md:grid-cols-2 gap-4">
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-database text-blue-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">전국 20,433개 시설 DB</h5>
                  <p class="text-sm text-gray-600">요양원, 요양병원, 재가복지센터 등</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-map-marked-alt text-blue-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">지역별 대표시설 우선 연결</h5>
                  <p class="text-sm text-gray-600">257개 지역 851개 대표시설</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-hand-holding-heart text-blue-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">복지 담당자 부담 제로</h5>
                  <p class="text-sm text-gray-600">시스템 자동 매칭으로 공정하게</p>
                </div>
              </div>
              <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-balance-scale text-blue-500 text-2xl mt-1"></i>
                <div>
                  <h5 class="font-bold text-gray-900 mb-1">투명한 견적 시스템</h5>
                  <p class="text-sm text-gray-600">대상자 가족이 직접 비교 선택</p>
                </div>
              </div>
            </div>

            {/* 특별고객 등록 폼 */}
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-6 rounded-xl border-2 border-blue-200">
              <h4 class="text-xl font-bold text-blue-900 mb-4">
                <i class="fas fa-star mr-2"></i>담당자용 가이드 신청
              </h4>
              <form id="govManagerForm" class="space-y-4">
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">기관명 *</label>
                    <input type="text" required class="w-full p-3 border rounded-lg" placeholder="예: 서울시 강남구청" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">담당자명 *</label>
                    <input type="text" required class="w-full p-3 border rounded-lg" placeholder="홍길동" />
                  </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">연락처 *</label>
                    <input type="tel" required class="w-full p-3 border rounded-lg" placeholder="010-0000-0000" />
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">이메일</label>
                    <input type="email" class="w-full p-3 border rounded-lg" placeholder="example@gov.kr" />
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">문의사항</label>
                  <textarea rows="3" class="w-full p-3 border rounded-lg" placeholder="궁금하신 점을 남겨주세요"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors">
                  <i class="fas fa-paper-plane mr-2"></i>담당자용 가이드 신청
                </button>
              </form>
            </div>

            {/* 추가 정보 */}
            <div class="text-center text-sm text-gray-500 space-y-2">
              <p><i class="fas fa-phone mr-1"></i>상담문의: 02-6677-4915</p>
              <p><i class="fas fa-comment mr-1"></i>카카오톡 상담: <a href="https://open.kakao.com/o/siR7YBUh" target="_blank" class="text-blue-600 hover:underline">바로가기</a></p>
            </div>
          </div>
        </div>
      </div>

      {/* 지역별 전화상담 모달 */}
      <div id="regionalCallModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
          <div class="sticky top-0 bg-gradient-to-r from-green-500 to-emerald-500 text-white p-6 rounded-t-2xl">
            <div class="flex justify-between items-center">
              <h3 class="text-2xl font-bold">
                <i class="fas fa-phone-alt mr-2"></i>지역별 전화상담
              </h3>
              <button onclick="document.getElementById('regionalCallModal').classList.add('hidden')" 
                      class="text-white hover:text-gray-200 text-2xl">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <p class="text-green-100 mt-2">내 지역의 대표 상담센터와 직접 통화하세요</p>
          </div>

          <div class="p-6 space-y-6">
            {/* 지역 선택 */}
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-map-marker-alt mr-1 text-green-500"></i>시/도 선택
              </label>
              <select id="sidoSelect" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                <option value="">시/도를 선택하세요</option>
              </select>
            </div>

            <div id="sigunguContainer" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-map-marker-alt mr-1 text-emerald-500"></i>시/군/구 선택
              </label>
              <select id="sigunguSelect" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-green-500">
                <option value="">시/군/구를 선택하세요</option>
              </select>
            </div>

            {/* 상담센터 목록 */}
            <div id="centerListContainer" class="hidden">
              <h4 class="text-lg font-bold text-gray-900 mb-4">
                <i class="fas fa-building mr-2 text-green-600"></i>대표 상담센터
              </h4>
              <div id="centerList" class="space-y-3"></div>
            </div>

            {/* 안내 메시지 */}
            <div id="noResultMessage" class="hidden">
              <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <p class="text-yellow-800 text-center">
                  <i class="fas fa-info-circle mr-2"></i>
                  해당 지역에 등록된 상담센터가 없습니다.<br/>
                  전체 상담은 <a href="tel:02-6677-4915" class="text-blue-600 font-bold underline">02-6677-4915</a>로 연락주세요.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script dangerouslySetInnerHTML={{
        __html: `
        // 전국 시도 및 시군구 데이터
        const regionData = {
          "서울특별시": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
          "부산광역시": ["강서구", "금정구", "기장군", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수영구", "연제구", "영도구", "중구", "해운대구"],
          "대구광역시": ["남구", "달서구", "달성군", "동구", "북구", "서구", "수성구", "중구"],
          "인천광역시": ["강화군", "계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "옹진군", "중구"],
          "광주광역시": ["광산구", "남구", "동구", "북구", "서구"],
          "대전광역시": ["대덕구", "동구", "서구", "유성구", "중구"],
          "울산광역시": ["남구", "동구", "북구", "울주군", "중구"],
          "세종특별자치시": ["세종시"],
          "경기도": ["가평군", "고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "양평군", "여주시", "연천군", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시"],
          "강원도": ["강릉시", "고성군", "동해시", "삼척시", "속초시", "양구군", "양양군", "영월군", "원주시", "인제군", "정선군", "철원군", "춘천시", "태백시", "평창군", "홍천군", "화천군", "횡성군"],
          "충청북도": ["괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "제천시", "증평군", "진천군", "청주시", "충주시"],
          "충청남도": ["계룡시", "공주시", "금산군", "논산시", "당진시", "보령시", "부여군", "서산시", "서천군", "아산시", "예산군", "천안시", "청양군", "태안군", "홍성군"],
          "전라북도": ["고창군", "군산시", "김제시", "남원시", "무주군", "부안군", "순창군", "완주군", "익산시", "임실군", "장수군", "전주시", "정읍시", "진안군"],
          "전라남도": ["강진군", "고흥군", "곡성군", "광양시", "구례군", "나주시", "담양군", "목포시", "무안군", "보성군", "순천시", "신안군", "여수시", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
          "경상북도": ["경산시", "경주시", "고령군", "구미시", "군위군", "김천시", "문경시", "봉화군", "상주시", "성주군", "안동시", "영덕군", "영양군", "영주시", "영천시", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군", "포항시"],
          "경상남도": ["거제시", "거창군", "고성군", "김해시", "남해군", "밀양시", "사천시", "산청군", "양산시", "의령군", "진주시", "창녕군", "창원시", "통영시", "하동군", "함안군", "함양군", "합천군"],
          "제주특별자치도": ["서귀포시", "제주시"]
        };

        // 시도 선택 옵션 생성
        const sidoSelect = document.getElementById('sidoSelect');
        Object.keys(regionData).forEach(sido => {
          const option = document.createElement('option');
          option.value = sido;
          option.textContent = sido;
          sidoSelect.appendChild(option);
        });

        // 시도 선택 시 시군구 로드
        sidoSelect.addEventListener('change', function() {
          const sigunguContainer = document.getElementById('sigunguContainer');
          const sigunguSelect = document.getElementById('sigunguSelect');
          const sido = this.value;
          
          // 이전 선택 초기화
          sigunguSelect.innerHTML = '<option value="">시/군/구를 선택하세요</option>';
          document.getElementById('centerListContainer').classList.add('hidden');
          document.getElementById('noResultMessage').classList.add('hidden');
          
          if (sido) {
            sigunguContainer.classList.remove('hidden');
            regionData[sido].forEach(sigungu => {
              const option = document.createElement('option');
              option.value = sigungu;
              option.textContent = sigungu;
              sigunguSelect.appendChild(option);
            });
          } else {
            sigunguContainer.classList.add('hidden');
          }
        });

        // 시군구 선택 시 상담센터 로드
        document.getElementById('sigunguSelect').addEventListener('change', async function() {
          const sido = sidoSelect.value;
          const sigungu = this.value;
          
          if (!sido || !sigungu) return;
          
          const regionKey = sido + '_' + sigungu;
          
          try {
            const response = await axios.get('/api/regional-centers?region=' + encodeURIComponent(regionKey));
            const centers = response.data.centers || [];
            
            const centerListContainer = document.getElementById('centerListContainer');
            const centerList = document.getElementById('centerList');
            const noResultMessage = document.getElementById('noResultMessage');
            
            if (centers.length > 0) {
              centerList.innerHTML = centers.map(center => \`
                <div class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 hover:shadow-lg transition-shadow">
                  <h5 class="font-bold text-lg text-gray-900 mb-2">
                    <i class="fas fa-building text-green-600 mr-2"></i>\${center.facilityName}
                  </h5>
                  <p class="text-sm text-gray-600 mb-2">
                    <i class="fas fa-tag text-purple-500 mr-1"></i>\${center.facilityType}
                  </p>
                  <div class="flex items-center mb-3">
                    <i class="fas fa-user text-blue-500 mr-2"></i>
                    <span class="text-sm text-gray-700">\${center.managerName}</span>
                  </div>
                  <a href="tel:\${center.managerPhone}" 
                     class="bg-gradient-to-r from-green-500 to-emerald-500 text-white px-6 py-3 rounded-lg hover:from-green-600 hover:to-emerald-600 transform hover:scale-105 transition-all shadow-md flex items-center justify-center w-full">
                    <i class="fas fa-phone-alt mr-2"></i>
                    <span class="font-bold">\${center.managerPhone}</span>
                  </a>
                </div>
              \`).join('');
              centerListContainer.classList.remove('hidden');
              noResultMessage.classList.add('hidden');
            } else {
              centerListContainer.classList.add('hidden');
              noResultMessage.classList.remove('hidden');
            }
          } catch (error) {
            console.error('상담센터 로드 실패:', error);
            document.getElementById('centerListContainer').classList.add('hidden');
            document.getElementById('noResultMessage').classList.remove('hidden');
          }
        });

        // 시설 입점 폼 - 시도 옵션 생성
        const facilitySidoSelect = document.getElementById('facilitySido');
        Object.keys(regionData).forEach(sido => {
          const option = document.createElement('option');
          option.value = sido;
          option.textContent = sido;
          facilitySidoSelect.appendChild(option);
        });

        // 시설 입점 폼 - 시도 선택 시 시군구 로드
        facilitySidoSelect.addEventListener('change', function() {
          const facilitySigunguSelect = document.getElementById('facilitySigungu');
          const sido = this.value;
          
          facilitySigunguSelect.innerHTML = '<option value="">시/군/구를 선택하세요</option>';
          
          if (sido) {
            facilitySigunguSelect.disabled = false;
            regionData[sido].forEach(sigungu => {
              const option = document.createElement('option');
              option.value = sigungu;
              option.textContent = sigungu;
              facilitySigunguSelect.appendChild(option);
            });
          } else {
            facilitySigunguSelect.disabled = true;
          }
        });

        // 파트너 폼 제출
        document.getElementById('partnerForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const data = {
            facilityName: document.getElementById('facilityName').value,
            facilityType: document.getElementById('facilityType').value,
            facilitySido: document.getElementById('facilitySido').value,
            facilitySigungu: document.getElementById('facilitySigungu').value,
            facilityAddress: document.getElementById('facilityAddress').value,
            managerName: document.getElementById('managerName').value,
            managerPhone: document.getElementById('managerPhone').value,
          };
          
          try {
            const response = await axios.post('/api/partner', data);
            alert(response.data.message);
            e.target.reset();
            document.getElementById('facilitySigungu').disabled = true;
          } catch (error) {
            alert('신청 중 오류가 발생했습니다.');
          }
        });
        `
      }} />
    </div>
  )
})

// 로그인 페이지
app.get('/login', (c) => {
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>로그인 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex items-center justify-center p-4">
      <div class="max-w-md w-full">
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold text-teal-600 mb-2">케어조아</h1>
          <p class="text-gray-600">로그인하여 서비스를 이용하세요</p>
        </div>
        
        <div class="bg-white rounded-2xl shadow-xl p-8">
          <div class="space-y-4">
            <a href="/api/auth/kakao/login" 
               class="w-full bg-yellow-400 hover:bg-yellow-500 text-gray-900 font-bold py-4 px-6 rounded-xl flex items-center justify-center transition-all duration-300 transform hover:scale-105">
              <i class="fas fa-comment text-2xl mr-3"></i>
              카카오 로그인
            </a>
            
            <div class="text-center py-4">
              <p class="text-gray-500 text-sm">간편하게 로그인하고</p>
              <p class="text-gray-500 text-sm">케어조아의 모든 서비스를 이용하세요</p>
            </div>
          </div>
          
          <div class="mt-6 pt-6 border-t border-gray-200 text-center">
            <a href="/" class="text-teal-600 hover:text-teal-700 font-medium">
              <i class="fas fa-arrow-left mr-2"></i>메인으로 돌아가기
            </a>
          </div>
        </div>
        
        <div class="mt-6 text-center text-sm text-gray-600">
          <p>로그인에 문제가 있으신가요?</p>
          <a href="tel:070-7004-5902" class="text-teal-600 hover:text-teal-700 font-medium">
            고객센터: 070-7004-5902
          </a>
        </div>
      </div>
    </body>
    </html>
  `)
})

// 회원가입 완료 페이지
app.get('/signup-complete', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>회원가입 완료 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gradient-to-br from-green-50 to-teal-50 min-h-screen flex items-center justify-center p-4">
      <div class="max-w-md w-full">
        <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
          <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-check text-4xl text-green-600"></i>
          </div>
          
          <h1 class="text-3xl font-bold text-gray-900 mb-4">
            환영합니다!
          </h1>
          <p class="text-gray-600 mb-8">
            케어조아 회원가입이 완료되었습니다.<br>
            이제 모든 서비스를 이용하실 수 있습니다.
          </p>
          
          <div class="space-y-3">
            <a href="/quotation/request" 
               class="block w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
              <i class="fas fa-file-invoice mr-2"></i>
              견적 신청하기
            </a>
            
            <a href="/my-page" 
               class="block w-full bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-4 px-6 rounded-xl transition-all duration-300">
              <i class="fas fa-user mr-2"></i>
              마이페이지
            </a>
            
            <a href="/" 
               class="block w-full text-teal-600 hover:text-teal-700 font-medium py-4">
              <i class="fas fa-home mr-2"></i>
              메인으로
            </a>
          </div>
        </div>
      </div>
    </body>
    </html>
  `)
})

// 일반 고객 회원가입
app.get('/signup/customer', async (c) => {
  const session = getUserSession(c)
  if (!session) return c.redirect('/login')
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <title>고객 회원가입 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 p-8">
      <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-teal-600 mb-6">일반 고객 회원가입</h1>
        <p class="text-gray-600 mb-4">회원가입이 완료되었습니다!</p>
        <a href="/" class="inline-block bg-teal-600 text-white px-6 py-3 rounded-lg hover:bg-teal-700">
          홈으로 이동
        </a>
      </div>
    </body>
    </html>
  `)
})

// 병원 담당자 회원가입
app.get('/signup/hospital-manager', async (c) => {
  const session = getUserSession(c)
  if (!session) return c.redirect('/login')
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <title>병원 담당자 회원가입 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 p-8">
      <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-red-600 mb-6">병원 담당자 회원가입</h1>
        <p class="text-gray-600 mb-4">회원가입이 완료되었습니다!</p>
        <a href="/" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700">
          홈으로 이동
        </a>
      </div>
    </body>
    </html>
  `)
})

// 주민센터 담당자 회원가입
app.get('/signup/welfare-manager', async (c) => {
  const session = getUserSession(c)
  if (!session) return c.redirect('/login')
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <title>주민센터 담당자 회원가입 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
    </head>
    <body class="bg-gray-50 p-8">
      <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-blue-600 mb-6">주민센터 담당자 회원가입</h1>
        <p class="text-gray-600 mb-4">회원가입이 완료되었습니다!</p>
        <a href="/" class="inline-block bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
          홈으로 이동
        </a>
      </div>
    </body>
    </html>
  `)
})

// 회원 타입 선택 페이지
app.get('/signup/select-type', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>회원 유형 선택 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    </head>
    <body class="bg-gradient-to-br from-blue-50 to-teal-50 min-h-screen flex items-center justify-center p-4">
      <div class="max-w-6xl w-full">
        <div class="text-center mb-8">
          <h1 class="text-4xl font-bold text-teal-600 mb-2">회원 유형 선택</h1>
          <p class="text-gray-600">케어조아 서비스를 어떻게 이용하시겠습니까?</p>
        </div>
        
        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- 일반 고객 -->
          <a href="/signup/customer" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-user text-4xl text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">일반 고객</h3>
            <p class="text-gray-600 text-center mb-4">
              직접 가족을 위한<br>
              요양 시설을 찾고 계신가요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 견적 신청</div>
              <div>✓ 시설 비교</div>
              <div>✓ 실시간 상담</div>
            </div>
          </a>
          
          <!-- 병원 담당자 -->
          <a href="/signup/hospital-manager" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105 border-2 border-red-200">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-hospital text-4xl text-red-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">병원 담당자</h3>
            <p class="text-gray-600 text-center mb-4">
              퇴원 환자를 요양 시설로<br>
              연결하시나요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 환자 대신 견적 신청</div>
              <div>✓ 빠른 시설 매칭</div>
              <div>✓ 중개 부담 ZERO</div>
            </div>
            <div class="mt-4 text-xs text-red-600 font-bold text-center">
              🏥 스페셜 회원
            </div>
          </a>
          
          <!-- 주민센터 담당자 -->
          <a href="/signup/welfare-manager" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105 border-2 border-blue-200">
            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-building text-4xl text-blue-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">주민센터 담당자</h3>
            <p class="text-gray-600 text-center mb-4">
              복지 대상자를 요양 시설로<br>
              연결하시나요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 대상자 대신 견적 신청</div>
              <div>✓ 투명한 매칭</div>
              <div>✓ 공정한 배분</div>
            </div>
            <div class="mt-4 text-xs text-blue-600 font-bold text-center">
              🏢 스페셜 회원
            </div>
          </a>
          
          <!-- 재가센터 -->
          <a href="/signup/facility?type=재가센터" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-home-heart text-4xl text-green-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">재가센터</h3>
            <p class="text-gray-600 text-center mb-4">
              재가복지센터를<br>
              운영하고 계신가요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 견적 요청 받기</div>
              <div>✓ 고객 매칭</div>
              <div>✓ 시설 홍보</div>
            </div>
          </a>
          
          <!-- 주야간보호센터 -->
          <a href="/signup/facility?type=주야간보호센터" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-clock text-4xl text-purple-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">주야간보호센터</h3>
            <p class="text-gray-600 text-center mb-4">
              주야간보호센터를<br>
              운영하고 계신가요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 견적 요청 받기</div>
              <div>✓ 고객 매칭</div>
              <div>✓ 시설 홍보</div>
            </div>
          </a>
          
          <!-- 요양원/실버타운 -->
          <a href="/signup/facility?type=요양원" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="w-20 h-20 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-building text-4xl text-orange-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">요양원/실버타운</h3>
            <p class="text-gray-600 text-center mb-4">
              요양원이나 실버타운을<br>
              운영하고 계신가요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 견적 요청 받기</div>
              <div>✓ 고객 매칭</div>
              <div>✓ 시설 홍보</div>
            </div>
          </a>
          
          <!-- 요양병원 -->
          <a href="/signup/facility?type=요양병원" class="bg-white rounded-2xl shadow-lg p-8 hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
            <div class="w-20 h-20 bg-pink-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <i class="fas fa-hospital-alt text-4xl text-pink-600"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-900 mb-3 text-center">요양병원</h3>
            <p class="text-gray-600 text-center mb-4">
              요양병원을<br>
              운영하고 계신가요?
            </p>
            <div class="text-sm text-gray-500 space-y-1">
              <div>✓ 견적 요청 받기</div>
              <div>✓ 고객 매칭</div>
              <div>✓ 시설 홍보</div>
            </div>
          </a>
        </div>
        
        <div class="mt-8 text-center">
          <a href="/api/auth/kakao/logout" class="text-gray-500 hover:text-gray-700">
            <i class="fas fa-arrow-left mr-2"></i>다시 선택하기
          </a>
        </div>
      </div>
    </body>
    </html>
  `)
})

// 마이페이지
app.get('/my-page', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  try {
    const { DB } = c.env
    const user = await DB.prepare(
      'SELECT * FROM users WHERE id = ?'
    ).bind(session.userId).first()
    
    if (!user) {
      return c.redirect('/login')
    }
    
    const userTypeLabel = user.user_type === 'customer' ? '일반 고객' : '시설 관리자'
    const userTypeColor = user.user_type === 'customer' ? 'blue' : 'purple'
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>마이페이지 - 케어조아</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
      </head>
      <body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
        <!-- 헤더 -->
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/" class="flex items-center space-x-3">
              <img 
                src="https://page.gensparksite.com/v1/base64_upload/b39dca8586af1dacd6d8417554313896" 
                alt="케어조아 로고"
                class="h-8 w-auto"
              />
              <h1 class="text-2xl font-bold text-teal-600">케어조아</h1>
            </a>
            <a href="/api/auth/kakao/logout" 
               class="text-gray-600 hover:text-red-600 transition-colors flex items-center space-x-2">
              <i class="fas fa-sign-out-alt"></i>
              <span>로그아웃</span>
            </a>
          </div>
        </header>

        <div class="max-w-6xl mx-auto p-4 py-8">
          <!-- 프로필 카드 -->
          <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-6">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6">
              <div class="flex items-center space-x-4 mb-4 md:mb-0">
                <div class="w-16 h-16 bg-gradient-to-br from-teal-400 to-blue-500 rounded-full flex items-center justify-center text-white text-2xl font-bold">
                  ${user.name.charAt(0)}
                </div>
                <div>
                  <h1 class="text-2xl md:text-3xl font-bold text-gray-900">${user.name}님</h1>
                  <div class="flex items-center space-x-2 mt-1">
                    <span class="inline-block px-3 py-1 bg-${userTypeColor}-100 text-${userTypeColor}-700 text-sm font-medium rounded-full">
                      <i class="fas fa-user-tag mr-1"></i>${userTypeLabel}
                    </span>
                    <span class="text-sm text-gray-500">
                      <i class="far fa-calendar mr-1"></i>가입일: ${new Date(user.created_at).toLocaleDateString('ko-KR')}
                    </span>
                  </div>
                </div>
              </div>
              <a href="/my-page/profile/edit" 
                 class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                <i class="fas fa-edit mr-2"></i>프로필 수정
              </a>
            </div>
            
            <!-- 사용자 정보 그리드 -->
            <div class="grid md:grid-cols-3 gap-4">
              <div class="p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200">
                <div class="text-sm text-blue-700 font-medium mb-1 flex items-center">
                  <i class="fas fa-envelope mr-2"></i>이메일
                </div>
                <div class="font-medium text-gray-900">${user.email}</div>
              </div>
              <div class="p-4 bg-gradient-to-br from-green-50 to-green-100 rounded-xl border border-green-200">
                <div class="text-sm text-green-700 font-medium mb-1 flex items-center">
                  <i class="fas fa-phone mr-2"></i>연락처
                </div>
                <div class="font-medium text-gray-900">${user.phone || '미등록'}</div>
              </div>
              <div class="p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl border border-purple-200">
                <div class="text-sm text-purple-700 font-medium mb-1 flex items-center">
                  <i class="fas fa-map-marker-alt mr-2"></i>주소
                </div>
                <div class="font-medium text-gray-900">${user.address || '미등록'}</div>
              </div>
            </div>
          </div>
          
          <!-- 빠른 메뉴 -->
          <div class="grid md:grid-cols-3 gap-4 mb-6">
            <a href="/quotation/request" 
               class="group block p-6 bg-white hover:bg-gradient-to-br hover:from-teal-500 hover:to-blue-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-file-invoice text-4xl text-teal-600 group-hover:text-white transition-colors"></i>
                <i class="fas fa-arrow-right text-gray-400 group-hover:text-white transition-colors"></i>
              </div>
              <div class="font-bold text-lg text-gray-900 group-hover:text-white transition-colors">견적 신청</div>
              <div class="text-sm text-gray-600 group-hover:text-white group-hover:opacity-90 transition-colors">새로운 견적 신청하기</div>
            </a>
            
            <a href="/my-page/quotations" 
               class="group block p-6 bg-white hover:bg-gradient-to-br hover:from-purple-500 hover:to-pink-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-list text-4xl text-purple-600 group-hover:text-white transition-colors"></i>
                <i class="fas fa-arrow-right text-gray-400 group-hover:text-white transition-colors"></i>
              </div>
              <div class="font-bold text-lg text-gray-900 group-hover:text-white transition-colors">내 견적 내역</div>
              <div class="text-sm text-gray-600 group-hover:text-white group-hover:opacity-90 transition-colors">견적서 확인 및 비교</div>
            </a>

            <a href="/my-page/messages" 
               class="group block p-6 bg-white hover:bg-gradient-to-br hover:from-orange-500 hover:to-red-600 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105">
              <div class="flex items-center justify-between mb-4">
                <i class="fas fa-comments text-4xl text-orange-600 group-hover:text-white transition-colors"></i>
                <i class="fas fa-arrow-right text-gray-400 group-hover:text-white transition-colors"></i>
              </div>
              <div class="font-bold text-lg text-gray-900 group-hover:text-white transition-colors">상담 메시지</div>
              <div class="text-sm text-gray-600 group-hover:text-white group-hover:opacity-90 transition-colors">시설과의 대화 내역</div>
            </a>
          </div>
          
          <div class="text-center">
            <a href="/" class="inline-flex items-center space-x-2 text-teal-600 hover:text-teal-700 font-medium">
              <i class="fas fa-home"></i>
              <span>메인으로 돌아가기</span>
            </a>
          </div>
        </div>
      </body>
      </html>
    `)
  } catch (error: any) {
    console.error('My page error:', error)
    return c.text('Error loading page: ' + error.message, 500)
  }
})

// 프로필 수정 페이지
app.get('/my-page/profile/edit', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  try {
    const { DB } = c.env
    const user = await DB.prepare(
      'SELECT * FROM users WHERE id = ?'
    ).bind(session.userId).first()
    
    if (!user) {
      return c.redirect('/login')
    }
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>프로필 수정 - 케어조아</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
      </head>
      <body class="bg-gradient-to-br from-gray-50 to-blue-50 min-h-screen">
        <header class="bg-white shadow-sm border-b">
          <div class="max-w-4xl mx-auto px-4 py-4 flex justify-between items-center">
            <a href="/my-page" class="flex items-center space-x-2 text-teal-600 hover:text-teal-700">
              <i class="fas fa-arrow-left"></i>
              <span>마이페이지로 돌아가기</span>
            </a>
          </div>
        </header>

        <div class="max-w-2xl mx-auto p-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6 flex items-center">
              <i class="fas fa-user-edit text-teal-600 mr-3"></i>
              프로필 수정
            </h1>
            
            <form action="/api/profile/update" method="POST" class="space-y-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-user mr-2 text-gray-400"></i>이름
                </label>
                <input 
                  type="text" 
                  name="name" 
                  value="${user.name}"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                  required
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-envelope mr-2 text-gray-400"></i>이메일
                </label>
                <input 
                  type="email" 
                  value="${user.email}"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100"
                  disabled
                />
                <p class="mt-1 text-sm text-gray-500">이메일은 변경할 수 없습니다.</p>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-phone mr-2 text-gray-400"></i>연락처
                </label>
                <input 
                  type="tel" 
                  name="phone" 
                  value="${user.phone || ''}"
                  placeholder="010-1234-5678"
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-2 text-gray-400"></i>주소
                </label>
                <input 
                  type="text" 
                  name="address" 
                  value="${user.address || ''}"
                  placeholder="서울시 강남구..."
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                />
              </div>
              
              <div class="flex space-x-4 pt-4">
                <button 
                  type="submit"
                  class="flex-1 bg-teal-600 text-white py-3 rounded-lg hover:bg-teal-700 transition-colors font-medium">
                  <i class="fas fa-save mr-2"></i>저장하기
                </button>
                <a 
                  href="/my-page"
                  class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 transition-colors font-medium text-center">
                  취소
                </a>
              </div>
            </form>
          </div>
        </div>

        <script>
          document.querySelector('form').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const formData = new FormData(e.target)
            const data = {
              name: formData.get('name'),
              phone: formData.get('phone'),
              address: formData.get('address')
            }
            
            try {
              const response = await fetch('/api/profile/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
              })
              
              if (response.ok) {
                alert('프로필이 수정되었습니다.')
                window.location.href = '/my-page'
              } else {
                const error = await response.json()
                alert('수정 실패: ' + (error.message || '알 수 없는 오류'))
              }
            } catch (error) {
              alert('네트워크 오류가 발생했습니다.')
            }
          })
        </script>
      </body>
      </html>
    `)
  } catch (error: any) {
    return c.text('Error loading profile: ' + error.message, 500)
  }
})

// 프로필 업데이트 API
app.post('/api/profile/update', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { name, phone, address } = await c.req.json()
    const { DB } = c.env
    
    await DB.prepare(`
      UPDATE users 
      SET name = ?, phone = ?, address = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(name, phone, address, session.userId).run()
    
    return c.json({ success: true })
  } catch (error: any) {
    return c.json({ error: error.message }, 500)
  }
})

// 견적 신청 페이지
app.get('/quotation/request', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  return c.html(`
    <!DOCTYPE html>
    <html lang="ko">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>견적 신청 - 케어조아</title>
      <script src="https://cdn.tailwindcss.com"></script>
      <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
      <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
    </head>
    <body class="bg-gray-50">
      <div class="max-w-4xl mx-auto p-4 py-8">
        <div class="bg-white rounded-2xl shadow-lg p-8">
          <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-file-invoice text-teal-600 mr-2"></i>
            견적 신청
          </h1>
          <p class="text-gray-600 mb-8">원하시는 시설 종류와 지역을 선택하시면, 해당 시설들에서 견적서를 보내드립니다.</p>
          
          <form id="quotationForm" class="space-y-6">
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-user mr-1"></i>환자 이름 *
                </label>
                <input type="text" id="patientName" required
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-birthday-cake mr-1"></i>환자 나이 *
                </label>
                <input type="number" id="patientAge" required min="1" max="120"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-venus-mars mr-1"></i>성별 *
              </label>
              <div class="flex gap-4">
                <label class="flex items-center">
                  <input type="radio" name="gender" value="남성" required class="mr-2">
                  <span>남성</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="gender" value="여성" class="mr-2">
                  <span>여성</span>
                </label>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-hospital mr-1"></i>시설 종류 *
              </label>
              <select id="facilityType" required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                <option value="">선택해주세요</option>
                <option value="재가복지">재가복지</option>
                <option value="요양원">요양원</option>
                <option value="주야간보호센터">주야간보호센터</option>
                <option value="요양병원">요양병원</option>
              </select>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-1"></i>시/도 *
                </label>
                <select id="sido" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                  <option value="">선택해주세요</option>
                  <option value="서울특별시">서울특별시</option>
                  <option value="부산광역시">부산광역시</option>
                  <option value="대구광역시">대구광역시</option>
                  <option value="인천광역시">인천광역시</option>
                  <option value="광주광역시">광주광역시</option>
                  <option value="대전광역시">대전광역시</option>
                  <option value="울산광역시">울산광역시</option>
                  <option value="세종특별자치시">세종특별자치시</option>
                  <option value="경기도">경기도</option>
                  <option value="강원도">강원도</option>
                  <option value="충청북도">충청북도</option>
                  <option value="충청남도">충청남도</option>
                  <option value="전라북도">전라북도</option>
                  <option value="전라남도">전라남도</option>
                  <option value="경상북도">경상북도</option>
                  <option value="경상남도">경상남도</option>
                  <option value="제주특별자치도">제주특별자치도</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-location-dot mr-1"></i>시/군/구 *
                </label>
                <input type="text" id="sigungu" required placeholder="예: 강남구, 해운대구"
                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-clipboard mr-1"></i>요양등급
              </label>
              <select id="careLevel"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                <option value="">선택해주세요 (선택사항)</option>
                <option value="1등급">1등급</option>
                <option value="2등급">2등급</option>
                <option value="3등급">3등급</option>
                <option value="4등급">4등급</option>
                <option value="5등급">5등급</option>
                <option value="인지지원등급">인지지원등급</option>
                <option value="등급외">등급외</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-notes-medical mr-1"></i>특별 요구사항
              </label>
              <textarea id="specialNeeds" rows="4" placeholder="예: 치매 환자, 휠체어 사용, 특별 식이 필요 등"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"></textarea>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                <i class="fas fa-calendar mr-1"></i>입소 희망일
              </label>
              <input type="date" id="preferredStartDate"
                     class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
            </div>
            
            <div class="flex gap-4">
              <button type="submit" 
                      class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                <i class="fas fa-paper-plane mr-2"></i>
                견적 신청하기
              </button>
              <a href="/my-page" 
                 class="px-6 py-4 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all">
                취소
              </a>
            </div>
          </form>
        </div>
      </div>
      
      <script>
        document.getElementById('quotationForm').addEventListener('submit', async (e) => {
          e.preventDefault()
          
          const formData = {
            patient_name: document.getElementById('patientName').value,
            patient_age: parseInt(document.getElementById('patientAge').value),
            patient_gender: document.querySelector('input[name="gender"]:checked').value,
            facility_type: document.getElementById('facilityType').value,
            region_sido: document.getElementById('sido').value,
            region_sigungu: document.getElementById('sigungu').value,
            care_level: document.getElementById('careLevel').value,
            special_needs: document.getElementById('specialNeeds').value,
            preferred_start_date: document.getElementById('preferredStartDate').value
          }
          
          try {
            const response = await axios.post('/api/quotation/request', formData)
            
            if (response.data.success) {
              alert('견적 신청이 완료되었습니다!\\n해당 지역의 시설들에서 곧 견적서를 보내드릴 예정입니다.')
              window.location.href = '/my-page/quotations'
            }
          } catch (error) {
            console.error('Error:', error)
            alert('견적 신청 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message))
          }
        })
      </script>
    </body>
    </html>
  `)
})

// 견적 신청 API
app.post('/api/quotation/request', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.json({ error: 'Not logged in' }, 401)
  }
  
  try {
    const { DB } = c.env
    const data = await c.req.json()
    
    // 견적 요청 저장
    const result = await DB.prepare(`
      INSERT INTO quotation_requests (
        customer_id, patient_name, patient_age, patient_gender,
        facility_type, region_sido, region_sigungu,
        care_level, special_needs, preferred_start_date, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 'pending')
    `).bind(
      session.userId,
      data.patient_name,
      data.patient_age,
      data.patient_gender,
      data.facility_type,
      data.region_sido,
      data.region_sigungu,
      data.care_level || null,
      data.special_needs || null,
      data.preferred_start_date || null
    ).run()
    
    const requestId = result.meta.last_row_id
    
    // TODO: 해당 지역 시설들에게 알림 발송 (이메일/카카오톡)
    
    return c.json({
      success: true,
      request_id: requestId,
      message: '견적 신청이 완료되었습니다.'
    })
  } catch (error: any) {
    console.error('Quotation request error:', error)
    return c.json({ 
      success: false,
      message: error.message 
    }, 500)
  }
})

// 시설 대시보드 (견적 요청 목록)
app.get('/facility/dashboard', async (c) => {
  const session = getUserSession(c)
  
  if (!session || session.userType !== 'facility') {
    return c.redirect('/login')
  }
  
  try {
    const { DB } = c.env
    
    // 시설 정보 가져오기
    const facility = await DB.prepare(
      'SELECT * FROM users WHERE id = ?'
    ).bind(session.userId).first()
    
    if (!facility) {
      return c.redirect('/login')
    }
    
    // 시설의 지역과 타입에 맞는 견적 요청 가져오기
    const requests = await DB.prepare(`
      SELECT qr.*, u.name as customer_name, u.phone as customer_phone
      FROM quotation_requests qr
      JOIN users u ON qr.customer_id = u.id
      WHERE qr.region_sido = ? 
        AND qr.region_sigungu = ?
        AND qr.facility_type = ?
        AND qr.status != 'closed'
      ORDER BY qr.created_at DESC
    `).bind(
      facility.region_sido,
      facility.region_sigungu,
      facility.facility_type
    ).all()
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>시설 대시보드 - 케어조아</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
      </head>
      <body class="bg-gray-50">
        <div class="max-w-7xl mx-auto p-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <div class="flex justify-between items-start mb-6">
              <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                  <i class="fas fa-building text-teal-600 mr-2"></i>
                  시설 대시보드
                </h1>
                <p class="text-gray-600">${facility.name} (${facility.facility_type})</p>
                <p class="text-sm text-gray-500">${facility.region_sido} ${facility.region_sigungu}</p>
              </div>
              <a href="/api/auth/kakao/logout" 
                 class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-sign-out-alt mr-1"></i>로그아웃
              </a>
            </div>
            
            <div class="grid md:grid-cols-3 gap-4 mb-6">
              <div class="p-4 bg-blue-50 rounded-xl">
                <div class="text-sm text-gray-600 mb-1">총 견적 요청</div>
                <div class="text-2xl font-bold text-blue-600">${requests.results.length}건</div>
              </div>
              <div class="p-4 bg-green-50 rounded-xl">
                <div class="text-sm text-gray-600 mb-1">대기 중</div>
                <div class="text-2xl font-bold text-green-600">${requests.results.filter((r: any) => r.status === 'pending').length}건</div>
              </div>
              <div class="p-4 bg-purple-50 rounded-xl">
                <div class="text-sm text-gray-600 mb-1">견적 제출 완료</div>
                <div class="text-2xl font-bold text-purple-600">${requests.results.filter((r: any) => r.status === 'quoted').length}건</div>
              </div>
            </div>
          </div>
          
          <div class="bg-white rounded-2xl shadow-lg p-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-6">
              <i class="fas fa-list mr-2"></i>
              견적 요청 목록
            </h2>
            
            ${requests.results.length === 0 ? `
              <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg">아직 견적 요청이 없습니다.</p>
                <p class="text-gray-400 text-sm mt-2">
                  ${facility.region_sido} ${facility.region_sigungu}에서 ${facility.facility_type} 견적 요청이 오면 알려드립니다.
                </p>
              </div>
            ` : `
              <div class="space-y-4">
                ${requests.results.map((req: any) => `
                  <div class="border border-gray-200 rounded-xl p-6 hover:shadow-md transition-all">
                    <div class="flex justify-between items-start mb-4">
                      <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-1">
                          ${req.patient_name}님 (${req.patient_age}세, ${req.patient_gender})
                        </h3>
                        <div class="flex gap-2 text-sm text-gray-600">
                          <span><i class="fas fa-map-marker-alt mr-1"></i>${req.region_sido} ${req.region_sigungu}</span>
                          <span><i class="fas fa-hospital mr-1"></i>${req.facility_type}</span>
                          ${req.care_level ? `<span><i class="fas fa-clipboard mr-1"></i>${req.care_level}</span>` : ''}
                        </div>
                      </div>
                      <span class="px-3 py-1 rounded-full text-sm font-medium ${
                        req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                        req.status === 'quoted' ? 'bg-green-100 text-green-800' : 
                        'bg-gray-100 text-gray-800'
                      }">
                        ${req.status === 'pending' ? '대기중' : req.status === 'quoted' ? '견적제출' : '마감'}
                      </span>
                    </div>
                    
                    ${req.special_needs ? `
                      <div class="mb-4 p-3 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">특별 요구사항</div>
                        <div class="text-gray-800">${req.special_needs}</div>
                      </div>
                    ` : ''}
                    
                    ${req.preferred_start_date ? `
                      <div class="mb-4 text-sm text-gray-600">
                        <i class="fas fa-calendar mr-1"></i>
                        입소 희망일: ${req.preferred_start_date}
                      </div>
                    ` : ''}
                    
                    <div class="flex gap-3 mt-4">
                      <a href="/facility/quotation/create/${req.id}" 
                         class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-xl text-center transition-all">
                        <i class="fas fa-file-invoice mr-2"></i>
                        견적서 작성
                      </a>
                      <button onclick="alert('연락처: ${req.customer_phone}')" 
                              class="px-6 py-3 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all">
                        <i class="fas fa-phone mr-2"></i>
                        연락하기
                      </button>
                    </div>
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      </body>
      </html>
    `)
  } catch (error: any) {
    console.error('Facility dashboard error:', error)
    return c.text('Error: ' + error.message, 500)
  }
})

// 견적서 작성 페이지
app.get('/facility/quotation/create/:requestId', async (c) => {
  const session = getUserSession(c)
  
  if (!session || session.userType !== 'facility') {
    return c.redirect('/login')
  }
  
  const requestId = c.req.param('requestId')
  
  try {
    const { DB } = c.env
    
    // 견적 요청 정보 가져오기
    const request = await DB.prepare(`
      SELECT qr.*, u.name as customer_name
      FROM quotation_requests qr
      JOIN users u ON qr.customer_id = u.id
      WHERE qr.id = ?
    `).bind(requestId).first()
    
    if (!request) {
      return c.text('견적 요청을 찾을 수 없습니다.', 404)
    }
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>견적서 작성 - 케어조아</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
        <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
      </head>
      <body class="bg-gray-50">
        <div class="max-w-4xl mx-auto p-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">
              <i class="fas fa-file-invoice text-teal-600 mr-2"></i>
              견적서 작성
            </h1>
            
            <div class="mb-8 p-6 bg-blue-50 rounded-xl">
              <h3 class="font-bold text-lg mb-3">견적 요청 정보</h3>
              <div class="grid md:grid-cols-2 gap-4 text-sm">
                <div>
                  <span class="text-gray-600">환자명:</span>
                  <span class="ml-2 font-medium">${request.patient_name}님</span>
                </div>
                <div>
                  <span class="text-gray-600">나이/성별:</span>
                  <span class="ml-2 font-medium">${request.patient_age}세 / ${request.patient_gender}</span>
                </div>
                <div>
                  <span class="text-gray-600">지역:</span>
                  <span class="ml-2 font-medium">${request.region_sido} ${request.region_sigungu}</span>
                </div>
                <div>
                  <span class="text-gray-600">시설 종류:</span>
                  <span class="ml-2 font-medium">${request.facility_type}</span>
                </div>
                ${request.care_level ? `
                  <div>
                    <span class="text-gray-600">요양등급:</span>
                    <span class="ml-2 font-medium">${request.care_level}</span>
                  </div>
                ` : ''}
              </div>
            </div>
            
            <form id="quotationForm" class="space-y-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-won-sign mr-1"></i>월 비용 (원) *
                  </label>
                  <input type="number" id="monthlyCost" required min="0" step="10000"
                         placeholder="예: 2000000"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-money-bill mr-1"></i>보증금 (원)
                  </label>
                  <input type="number" id="deposit" min="0" step="100000"
                         placeholder="예: 5000000 (선택사항)"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-check-circle mr-1"></i>포함 서비스 *
                </label>
                <textarea id="includedServices" required rows="5"
                          placeholder="예:&#10;- 식사 제공 (1일 3식)&#10;- 간호사 상주 24시간&#10;- 물리치료 주 2회&#10;- 세탁 서비스&#10;- 정기 건강검진"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"></textarea>
              </div>
              
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1"></i>담당자 이름 *
                  </label>
                  <input type="text" id="contactPerson" required
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-phone mr-1"></i>연락처 *
                  </label>
                  <input type="tel" id="contactPhone" required
                         placeholder="010-1234-5678"
                         class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-info-circle mr-1"></i>추가 정보
                </label>
                <textarea id="additionalInfo" rows="4"
                          placeholder="시설 특징, 공실 현황, 방문 안내 등"
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500"></textarea>
              </div>
              
              <div class="flex gap-4">
                <button type="submit" 
                        class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-xl transition-all duration-300 transform hover:scale-105">
                  <i class="fas fa-paper-plane mr-2"></i>
                  견적서 제출하기
                </button>
                <a href="/facility/dashboard" 
                   class="px-6 py-4 border-2 border-gray-300 text-gray-700 font-medium rounded-xl hover:bg-gray-50 transition-all">
                  취소
                </a>
              </div>
            </form>
          </div>
        </div>
        
        <script>
          document.getElementById('quotationForm').addEventListener('submit', async (e) => {
            e.preventDefault()
            
            const formData = {
              request_id: ${requestId},
              monthly_cost: parseInt(document.getElementById('monthlyCost').value),
              deposit: parseInt(document.getElementById('deposit').value) || 0,
              included_services: document.getElementById('includedServices').value,
              contact_person: document.getElementById('contactPerson').value,
              contact_phone: document.getElementById('contactPhone').value,
              additional_info: document.getElementById('additionalInfo').value
            }
            
            try {
              const response = await axios.post('/api/facility/quotation/submit', formData)
              
              if (response.data.success) {
                alert('견적서가 제출되었습니다!')
                window.location.href = '/facility/dashboard'
              }
            } catch (error) {
              console.error('Error:', error)
              alert('견적서 제출 중 오류가 발생했습니다: ' + (error.response?.data?.message || error.message))
            }
          })
        </script>
      </body>
      </html>
    `)
  } catch (error: any) {
    console.error('Create quotation error:', error)
    return c.text('Error: ' + error.message, 500)
  }
})

// 견적서 제출 API
app.post('/api/facility/quotation/submit', async (c) => {
  const session = getUserSession(c)
  
  if (!session || session.userType !== 'facility') {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const data = await c.req.json()
    
    // 견적서 저장
    await DB.prepare(`
      INSERT INTO quotations (
        request_id, facility_id, monthly_cost, deposit,
        included_services, additional_info,
        contact_person, contact_phone, status
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'sent')
    `).bind(
      data.request_id,
      session.userId,
      data.monthly_cost,
      data.deposit,
      data.included_services,
      data.additional_info || null,
      data.contact_person,
      data.contact_phone
    ).run()
    
    // 견적 요청 상태 업데이트
    await DB.prepare(`
      UPDATE quotation_requests 
      SET status = 'quoted', updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(data.request_id).run()
    
    // TODO: 고객에게 견적서 도착 알림
    
    return c.json({
      success: true,
      message: '견적서가 제출되었습니다.'
    })
  } catch (error: any) {
    console.error('Submit quotation error:', error)
    return c.json({ 
      success: false,
      message: error.message 
    }, 500)
  }
})

// 고객 견적 내역 페이지
app.get('/my-page/quotations', async (c) => {
  const session = getUserSession(c)
  
  if (!session) {
    return c.redirect('/login')
  }
  
  try {
    const { DB } = c.env
    
    // 내 견적 요청 목록
    const requests = await DB.prepare(`
      SELECT * FROM quotation_requests
      WHERE customer_id = ?
      ORDER BY created_at DESC
    `).bind(session.userId).all()
    
    // 각 요청에 대한 견적서 수 가져오기
    const requestsWithQuotes = await Promise.all(
      requests.results.map(async (req: any) => {
        const quotes = await DB.prepare(`
          SELECT q.*, u.name as facility_name, u.facility_type, u.phone as facility_phone
          FROM quotations q
          JOIN users u ON q.facility_id = u.id
          WHERE q.request_id = ?
          ORDER BY q.monthly_cost ASC
        `).bind(req.id).all()
        
        return { ...req, quotes: quotes.results }
      })
    )
    
    return c.html(`
      <!DOCTYPE html>
      <html lang="ko">
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>내 견적 내역 - 케어조아</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
      </head>
      <body class="bg-gray-50">
        <div class="max-w-7xl mx-auto p-4 py-8">
          <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <div class="flex justify-between items-start mb-6">
              <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-list text-teal-600 mr-2"></i>
                내 견적 내역
              </h1>
              <a href="/my-page" class="text-teal-600 hover:text-teal-700 font-medium">
                <i class="fas fa-arrow-left mr-2"></i>마이페이지
              </a>
            </div>
            
            ${requestsWithQuotes.length === 0 ? `
              <div class="text-center py-12">
                <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                <p class="text-gray-500 text-lg mb-4">아직 견적 요청 내역이 없습니다.</p>
                <a href="/quotation/request" 
                   class="inline-block bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-xl transition-all">
                  <i class="fas fa-plus mr-2"></i>
                  견적 신청하기
                </a>
              </div>
            ` : `
              <div class="space-y-6">
                ${requestsWithQuotes.map((req: any) => `
                  <div class="border-2 border-gray-200 rounded-xl p-6">
                    <div class="flex justify-between items-start mb-4">
                      <div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-2">
                          ${req.patient_name}님 (${req.patient_age}세, ${req.patient_gender})
                        </h3>
                        <div class="flex flex-wrap gap-3 text-sm text-gray-600">
                          <span><i class="fas fa-map-marker-alt mr-1"></i>${req.region_sido} ${req.region_sigungu}</span>
                          <span><i class="fas fa-hospital mr-1"></i>${req.facility_type}</span>
                          ${req.care_level ? `<span><i class="fas fa-clipboard mr-1"></i>${req.care_level}</span>` : ''}
                          <span><i class="fas fa-calendar mr-1"></i>${new Date(req.created_at).toLocaleDateString()}</span>
                        </div>
                      </div>
                      <span class="px-4 py-2 rounded-full text-sm font-bold ${
                        req.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 
                        req.status === 'quoted' ? 'bg-green-100 text-green-800' : 
                        'bg-gray-100 text-gray-800'
                      }">
                        ${req.status === 'pending' ? '대기중' : req.status === 'quoted' ? `${req.quotes.length}개 견적서 도착` : '마감'}
                      </span>
                    </div>
                    
                    ${req.quotes.length === 0 ? `
                      <div class="bg-blue-50 p-4 rounded-lg text-center">
                        <i class="fas fa-hourglass-half text-blue-600 mr-2"></i>
                        <span class="text-blue-800">시설에서 견적서를 준비 중입니다...</span>
                      </div>
                    ` : `
                      <div class="mt-4">
                        <h4 class="font-bold text-lg mb-3">
                          <i class="fas fa-file-invoice text-teal-600 mr-2"></i>
                          받은 견적서 (${req.quotes.length}개)
                        </h4>
                        <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                          ${req.quotes.map((quote: any, idx: number) => `
                            <div class="border border-gray-200 rounded-xl p-4 hover:shadow-lg transition-all ${idx === 0 ? 'border-teal-500 border-2' : ''}">
                              ${idx === 0 ? '<div class="text-xs text-teal-600 font-bold mb-2">💰 최저가</div>' : ''}
                              <div class="mb-3">
                                <div class="font-bold text-lg text-gray-900">${quote.facility_name}</div>
                                <div class="text-sm text-gray-500">${quote.facility_type}</div>
                              </div>
                              
                              <div class="mb-3">
                                <div class="text-sm text-gray-600">월 비용</div>
                                <div class="text-2xl font-bold text-teal-600">
                                  ${quote.monthly_cost.toLocaleString()}원
                                </div>
                              </div>
                              
                              ${quote.deposit > 0 ? `
                                <div class="mb-3 text-sm">
                                  <span class="text-gray-600">보증금:</span>
                                  <span class="font-medium">${quote.deposit.toLocaleString()}원</span>
                                </div>
                              ` : ''}
                              
                              <div class="mb-3 text-sm">
                                <div class="text-gray-600 mb-1">포함 서비스:</div>
                                <div class="text-gray-800 text-xs whitespace-pre-line line-clamp-3">${quote.included_services}</div>
                              </div>
                              
                              <div class="mb-4 text-sm">
                                <div class="text-gray-600">담당자:</div>
                                <div class="font-medium">${quote.contact_person} (${quote.contact_phone})</div>
                              </div>
                              
                              <button onclick="alert('연락처: ${quote.facility_phone}\\n담당자: ${quote.contact_person} (${quote.contact_phone})')"
                                      class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg transition-all">
                                <i class="fas fa-phone mr-2"></i>
                                연락하기
                              </button>
                            </div>
                          `).join('')}
                        </div>
                      </div>
                    `}
                  </div>
                `).join('')}
              </div>
            `}
          </div>
        </div>
      </body>
      </html>
    `)
  } catch (error: any) {
    console.error('My quotations error:', error)
    return c.text('Error: ' + error.message, 500)
  }
})

// 가족 간병 등록 페이지
app.get('/family-care-register', (c) => {
  return c.render(
    <div>
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <a href="/" class="flex items-center">
              <img 
                src="https://page.gensparksite.com/v1/base64_upload/b39dca8586af1dacd6d8417554313896" 
                alt="케어조아 로고"
                class="h-8 w-auto mr-3"
              />
              <h1 class="text-2xl font-bold text-teal-600">케어조아</h1>
            </a>
            <a href="/" class="text-gray-600 hover:text-gray-900">
              <i class="fas fa-home mr-1"></i>홈으로
            </a>
          </div>
        </div>
      </header>

      <section class="py-16 bg-gradient-to-br from-green-50 to-emerald-50 min-h-screen">
        <div class="max-w-4xl mx-auto px-4">
          <div class="text-center mb-12">
            <h2 class="text-4xl font-bold text-gray-900 mb-4">
              <i class="fas fa-heart text-green-600 mr-3"></i>가족 간병 등록
            </h2>
            <p class="text-lg text-gray-600">가족간병등록 신청을 도와드립니다.</p>
          </div>

          <div class="bg-white p-8 rounded-2xl shadow-lg">
            <form id="familyCareForm" class="space-y-6">
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user mr-1 text-blue-500"></i>보호자 이름*
                  </label>
                  <input type="text" id="guardianName" required class="w-full p-3 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-phone mr-1 text-green-500"></i>연락처*
                  </label>
                  <input type="tel" id="guardianPhone" required class="w-full p-3 border rounded-lg" placeholder="010-0000-0000" />
                </div>
              </div>

              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-user-injured mr-1 text-purple-500"></i>환자 이름*
                  </label>
                  <input type="text" id="patientName" required class="w-full p-3 border rounded-lg" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-calendar mr-1 text-orange-500"></i>환자 나이*
                  </label>
                  <input type="number" id="patientAge" required class="w-full p-3 border rounded-lg" placeholder="예: 75" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-1 text-red-500"></i>지역*
                </label>
                <input type="text" id="region" required class="w-full p-3 border rounded-lg" placeholder="예: 서울시 강남구" />
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-notes-medical mr-1 text-teal-500"></i>상세 요청사항
                </label>
                <textarea id="requirements" rows="4" class="w-full p-3 border rounded-lg" placeholder="필요한 간병 서비스나 특별한 요구사항을 적어주세요"></textarea>
              </div>

              <div class="text-center pt-6">
                <button type="submit" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-12 py-4 rounded-lg hover:from-green-700 hover:to-emerald-700 transform hover:scale-105 font-bold">
                  <i class="fas fa-heart mr-2"></i>가족 간병 등록 신청
                </button>
              </div>
            </form>
          </div>
        </div>
      </section>

      <script dangerouslySetInnerHTML={{
        __html: `
        document.getElementById('familyCareForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const data = {
            guardianName: document.getElementById('guardianName').value,
            guardianPhone: document.getElementById('guardianPhone').value,
            patientName: document.getElementById('patientName').value,
            patientAge: document.getElementById('patientAge').value,
            region: document.getElementById('region').value,
            requirements: document.getElementById('requirements').value,
          };
          
          try {
            const response = await axios.post('/api/family-care', data);
            alert(response.data.message);
            window.location.href = '/';
          } catch (error) {
            alert('등록 중 오류가 발생했습니다.');
          }
        });
        `
      }} />
    </div>
  )
})

// 전국 요양시설 찾기 페이지
app.get('/facilities', (c) => {
  return c.render(
    <div>
      {/* Leaflet CSS */}
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="" />
      
      {/* Leaflet JS */}
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
        crossorigin=""></script>
      
      <header class="bg-white shadow-sm border-b sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <a href="/" class="flex items-center">
              <img 
                src="https://page.gensparksite.com/v1/base64_upload/b39dca8586af1dacd6d8417554313896" 
                alt="케어조아 로고"
                class="h-8 w-auto mr-3"
              />
              <h1 class="text-2xl font-bold text-teal-600">케어조아</h1>
            </a>
            <a href="/" class="text-gray-600 hover:text-gray-900">
              <i class="fas fa-home mr-1"></i>홈으로
            </a>
          </div>
        </div>
      </header>

      <section class="min-h-screen bg-gray-50 py-8">
        <div class="max-w-7xl mx-auto px-4">
          <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-gray-900 mb-4">
              <i class="fas fa-search-location text-purple-600 mr-3"></i>전국 요양시설 찾기
            </h2>
            <p class="text-lg text-gray-600" id="facilityCountHeader">전국 요양시설 정보를 확인하세요</p>
          </div>

          {/* 검색 필터 */}
          <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <div class="grid md:grid-cols-4 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-1 text-blue-500"></i>시/도
                </label>
                <select id="filterSido" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                  <option value="">전체</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-map-marker-alt mr-1 text-green-500"></i>시/군/구
                </label>
                <select id="filterSigungu" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" disabled>
                  <option value="">전체</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-hospital mr-1 text-purple-500"></i>시설 유형
                </label>
                <select id="filterType" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500">
                  <option value="">전체</option>
                  <option value="요양병원">요양병원</option>
                  <option value="요양원">요양원</option>
                  <option value="재가복지센터">재가복지센터</option>
                  <option value="주야간보호">주야간보호</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">
                  <i class="fas fa-search mr-1 text-orange-500"></i>시설명 검색
                </label>
                <input type="text" id="searchKeyword" 
                  class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-purple-500" 
                  placeholder="시설명 입력" />
              </div>
            </div>
            
            <div class="flex gap-3 mt-4">
              <button onclick="searchFacilities()" 
                class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white py-3 rounded-lg hover:from-purple-700 hover:to-pink-700 font-bold">
                <i class="fas fa-search mr-2"></i>검색
              </button>
              <button onclick="resetSearch()" 
                class="px-6 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 font-bold">
                <i class="fas fa-redo mr-2"></i>초기화
              </button>
            </div>
          </div>

          {/* 결과 통계 */}
          <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl p-4 mb-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-purple-100 text-sm">검색 결과</p>
                <p class="text-3xl font-bold" id="resultCount">0</p>
              </div>
              <i class="fas fa-hospital text-5xl text-purple-200"></i>
            </div>
          </div>

          {/* 지도 & 리스트 */}
          <div class="grid lg:grid-cols-2 gap-6">
            {/* 리스트 영역 */}
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
              <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4">
                <h3 class="text-xl font-bold">
                  <i class="fas fa-list mr-2"></i>시설 목록
                </h3>
              </div>
              <div id="facilityList" class="h-[600px] overflow-y-auto p-4">
                <div class="text-center text-gray-500 py-20">
                  <i class="fas fa-search text-6xl mb-4"></i>
                  <p class="text-lg font-medium">검색 조건을 선택하고<br/>검색 버튼을 클릭하세요</p>
                </div>
              </div>
            </div>

            {/* 지도 영역 */}
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
              <div class="bg-gradient-to-r from-purple-600 to-pink-600 text-white p-4">
                <h3 class="text-xl font-bold">
                  <i class="fas fa-map-marked-alt mr-2"></i>지도로 보기
                </h3>
              </div>
              <div id="map" class="w-full h-[600px] bg-gray-100"></div>
            </div>
          </div>

          {/* 로딩 표시 */}
          <div id="loadingSpinner" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl p-8 text-center">
              <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-purple-600 mx-auto mb-4"></div>
              <p class="text-lg font-bold text-gray-900">데이터 로딩 중...</p>
              <p class="text-sm text-gray-600 mt-2">잠시만 기다려주세요</p>
            </div>
          </div>
        </div>
      </section>

      <script dangerouslySetInnerHTML={{
        __html: `
        // 전국 시도 및 시군구 데이터
        const regionData = {
          "서울특별시": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
          "부산광역시": ["강서구", "금정구", "기장군", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수영구", "연제구", "영도구", "중구", "해운대구"],
          "대구광역시": ["남구", "달서구", "달성군", "동구", "북구", "서구", "수성구", "중구"],
          "인천광역시": ["강화군", "계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "옹진군", "중구"],
          "광주광역시": ["광산구", "남구", "동구", "북구", "서구"],
          "대전광역시": ["대덕구", "동구", "서구", "유성구", "중구"],
          "울산광역시": ["남구", "동구", "북구", "울주군", "중구"],
          "세종특별자치시": ["세종시"],
          "경기도": ["가평군", "고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "양평군", "여주시", "연천군", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시"],
          "강원특별자치도": ["강릉시", "고성군", "동해시", "삼척시", "속초시", "양구군", "양양군", "영월군", "원주시", "인제군", "정선군", "철원군", "춘천시", "태백시", "평창군", "홍천군", "화천군", "횡성군"],
          "충청북도": ["괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "제천시", "증평군", "진천군", "청주시", "충주시"],
          "충청남도": ["계룡시", "공주시", "금산군", "논산시", "당진시", "보령시", "부여군", "서산시", "서천군", "아산시", "예산군", "천안시", "청양군", "태안군", "홍성군"],
          "전북특별자치도": ["고창군", "군산시", "김제시", "남원시", "무주군", "부안군", "순창군", "완주군", "익산시", "임실군", "장수군", "전주시", "정읍시", "진안군"],
          "전라남도": ["강진군", "고흥군", "곡성군", "광양시", "구례군", "나주시", "담양군", "목포시", "무안군", "보성군", "순천시", "신안군", "여수시", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
          "경상북도": ["경산시", "경주시", "고령군", "구미시", "군위군", "김천시", "문경시", "봉화군", "상주시", "성주군", "안동시", "영덕군", "영양군", "영주시", "영천시", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군", "포항시"],
          "경상남도": ["거제시", "거창군", "고성군", "김해시", "남해군", "밀양시", "사천시", "산청군", "양산시", "의령군", "진주시", "창녕군", "창원시", "통영시", "하동군", "함안군", "함양군", "합천군"],
          "제주특별자치도": ["서귀포시", "제주시"]
        };

        let allFacilities = [];
        let filteredFacilities = [];
        let map = null;
        let markers = [];

        // Leaflet 지도 초기화
        function initLeafletMap() {
          console.log('🗺️ Leaflet 지도 초기화 시작');
          
          // 지도 생성 (서울 중심)
          map = L.map('map').setView([37.5665, 126.9780], 7);
          
          // OpenStreetMap 타일 레이어 추가
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
          }).addTo(map);
          
          console.log('✅ Leaflet 지도 초기화 완료');
        }

        // 지도에 마커 표시
        function displayMarkersOnMap() {
          // 기존 마커 제거
          markers.forEach(marker => map.removeLayer(marker));
          markers = [];

          // 최대 100개 마커 표시
          const displayList = filteredFacilities.slice(0, 100);
          
          if (displayList.length === 0) return;

          // 시설 유형별 마커 색상
          const typeColors = {
            '요양병원': '#ef4444',    // 빨강
            '요양원': '#3b82f6',       // 파랑
            '재가복지센터': '#10b981', // 초록
            '주야간보호': '#f59e0b'    // 주황
          };

          displayList.forEach(facility => {
            if (!facility.lat || !facility.lng) return;

            // 커스텀 마커 아이콘
            const markerColor = typeColors[facility.type] || '#6b7280';
            const markerIcon = L.divIcon({
              className: 'custom-marker',
              html: \`<div style="background-color: \${markerColor}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>\`,
              iconSize: [24, 24],
              iconAnchor: [12, 12]
            });

            // 마커 생성
            const marker = L.marker([facility.lat, facility.lng], {
              icon: markerIcon
            }).addTo(map);

            // 팝업 내용
            const popupContent = \`
              <div style="min-width:200px;">
                <div style="font-weight:bold;margin-bottom:5px;color:\${markerColor};font-size:12px;">
                  \${facility.type}
                </div>
                <div style="font-size:14px;margin-bottom:5px;font-weight:600;">
                  \${facility.name}
                </div>
                <div style="font-size:12px;color:#666;">
                  📍 \${facility.address}
                </div>
                <div style="font-size:11px;color:#999;margin-top:5px;">
                  \${facility.sido} \${facility.sigungu}
                </div>
              </div>
            \`;

            marker.bindPopup(popupContent);
            markers.push(marker);
          });

          // 첫 번째 시설로 지도 중심 이동
          if (displayList.length > 0 && displayList[0].lat && displayList[0].lng) {
            map.setView([displayList[0].lat, displayList[0].lng], 12);
          }
          
          console.log(\`📍 \${displayList.length}개 마커 표시 완료\`);
        }

        // 데이터베이스에서 시설 데이터 로드
        async function loadFacilitiesData() {
          try {
            document.getElementById('loadingSpinner').classList.remove('hidden');
            
            // 데이터베이스 API 호출
            const response = await fetch('/api/facilities-from-db');
            const data = await response.json();
            
            if (!data.success || !data.facilities) {
              throw new Error('데이터 로드 실패');
            }
            
            // 데이터베이스에서 가져온 데이터 변환
            allFacilities = data.facilities.map((f, idx) => ({
              id: f.id || idx + 1,
              type: f.facility_type || '',
              name: f.name || '',
              address: f.address || '',
              sido: f.sido || '',
              sigungu: f.sigungu || '',
              lat: parseFloat(f.latitude) || 0,
              lng: parseFloat(f.longitude) || 0
            }));
            
            console.log('✅ 로드된 시설 수:', allFacilities.length);
            
            // 데이터 검증 - 처음 5개 샘플 출력
            console.log('📋 데이터 샘플 (처음 5개):');
            allFacilities.slice(0, 5).forEach((f, idx) => {
              console.log(\`  \${idx + 1}. \${f.name} | \${f.sido} \${f.sigungu} | \${f.type}\`);
            });
            
            filteredFacilities = allFacilities;
            
            // 헤더 텍스트 업데이트 (시설 수 숨김)
            const headerElement = document.getElementById('facilityCountHeader');
            if (headerElement) {
              headerElement.textContent = \`전국 요양시설 정보를 확인하세요\`;
            }
            
            document.getElementById('loadingSpinner').classList.add('hidden');
            displayResults();
          } catch (error) {
            console.error('❌ 데이터 로드 실패:', error);
            document.getElementById('loadingSpinner').classList.add('hidden');
            alert('데이터를 불러오는데 실패했습니다.');
          }
        }

        // 시도 선택 옵션 생성
        const sidoSelect = document.getElementById('filterSido');
        Object.keys(regionData).forEach(sido => {
          const option = document.createElement('option');
          option.value = sido;
          option.textContent = sido;
          sidoSelect.appendChild(option);
        });

        // 시도 변경 시 시군구 로드
        sidoSelect.addEventListener('change', function() {
          const sigunguSelect = document.getElementById('filterSigungu');
          sigunguSelect.innerHTML = '<option value="">전체</option>';
          
          if (this.value) {
            sigunguSelect.disabled = false;
            regionData[this.value].forEach(sigungu => {
              const option = document.createElement('option');
              option.value = sigungu;
              option.textContent = sigungu;
              sigunguSelect.appendChild(option);
            });
          } else {
            sigunguSelect.disabled = true;
          }
        });

        // 검색 실행
        function searchFacilities() {
          const sido = document.getElementById('filterSido').value;
          const sigungu = document.getElementById('filterSigungu').value;
          const type = document.getElementById('filterType').value;
          const keyword = document.getElementById('searchKeyword').value.trim().toLowerCase();

          console.log('🔍 검색 조건:', { sido, sigungu, type, keyword });
          console.log('📊 전체 시설 수:', allFacilities.length);

          filteredFacilities = allFacilities.filter(facility => {
            if (sido && facility.sido !== sido) return false;
            if (sigungu && facility.sigungu !== sigungu) return false;
            if (type && facility.type !== type) return false;
            if (keyword && !facility.name.toLowerCase().includes(keyword)) return false;
            return true;
          });

          console.log('✅ 필터링 결과:', filteredFacilities.length);
          
          // 필터링 결과가 0개이고 조건이 있을 때 샘플 데이터 확인
          if (filteredFacilities.length === 0 && (sido || sigungu || type)) {
            console.log('⚠️ 검색 결과 없음. 샘플 데이터 확인:');
            const samples = allFacilities.slice(0, 3);
            samples.forEach(s => {
              console.log('샘플:', {
                name: s.name,
                sido: s.sido,
                sigungu: s.sigungu,
                type: s.type
              });
            });
          }

          displayResults();
        }

        // 검색 초기화
        function resetSearch() {
          document.getElementById('filterSido').value = '';
          document.getElementById('filterSigungu').value = '';
          document.getElementById('filterSigungu').disabled = true;
          document.getElementById('filterType').value = '';
          document.getElementById('searchKeyword').value = '';
          
          filteredFacilities = allFacilities;
          displayResults();
        }

        // 결과 표시
        function displayResults() {
          // 결과 수 업데이트 (전체 시설 수 숨김 - 검색 결과만 표시)
          const resultCountElement = document.getElementById('resultCount');
          if (resultCountElement) {
            // 필터 요소들이 존재하는지 확인 후 값 가져오기
            const sidoElement = document.getElementById('sidoFilter');
            const sigunguElement = document.getElementById('sigunguFilter');
            const typeElement = document.getElementById('typeFilter');
            const keywordElement = document.getElementById('searchKeyword');
            
            const sido = sidoElement ? sidoElement.value : '';
            const sigungu = sigunguElement ? sigunguElement.value : '';
            const type = typeElement ? typeElement.value : '';
            const keyword = keywordElement ? keywordElement.value.trim() : '';
            
            if (sido || sigungu || type || keyword) {
              resultCountElement.textContent = filteredFacilities.length.toLocaleString();
            } else {
              resultCountElement.textContent = '전체';
            }
          }

          // 지도에 마커 표시
          displayMarkersOnMap();

          // 리스트 표시 (최대 100개)
          const facilityList = document.getElementById('facilityList');
          const displayList = filteredFacilities.slice(0, 100);
          
          if (displayList.length === 0) {
            facilityList.innerHTML = \`
              <div class="text-center text-gray-500 py-20">
                <i class="fas fa-search text-6xl mb-4"></i>
                <p class="text-lg font-medium">검색 결과가 없습니다</p>
                <p class="text-sm mt-2">다른 조건으로 검색해보세요</p>
              </div>
            \`;
          } else {
            facilityList.innerHTML = displayList.map((facility, index) => \`
              <div class="border-b border-gray-200 py-4 hover:bg-purple-50 px-3 rounded-lg transition-colors">
                <div class="flex items-start justify-between">
                  <div class="flex-1">
                    <h4 class="font-bold text-lg text-gray-900 mb-2">
                      <span class="inline-block bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded mr-2">
                        \${facility.type}
                      </span>
                      \${facility.name}
                    </h4>
                    <p class="text-sm text-gray-600 mb-1">
                      <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>
                      \${facility.address}
                    </p>
                    <p class="text-xs text-gray-500">
                      <i class="fas fa-map text-blue-500 mr-1"></i>
                      \${facility.sido} \${facility.sigungu}
                    </p>
                  </div>
                  <button onclick="showOnMap(\${facility.lat}, \${facility.lng}, '\${facility.name.replace(/'/g, "\\\\'")}\')" 
                    class="ml-3 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 text-sm flex-shrink-0">
                    <i class="fas fa-map-marker-alt mr-1"></i>지도
                  </button>
                </div>
              </div>
            \`).join('');
            
            if (filteredFacilities.length > 100) {
              facilityList.innerHTML += \`
                <div class="text-center py-6 text-gray-500">
                  <p class="text-sm">상위 100개만 표시됩니다</p>
                  <p class="text-xs mt-1">더 정확한 검색을 위해 필터를 사용하세요</p>
                </div>
              \`;
            }
          }
        }

        // 특정 시설을 지도에 표시
        function showOnMap(lat, lng, name) {
          if (!map) {
            alert('지도를 초기화하는 중입니다. 잠시 후 다시 시도해주세요.');
            return;
          }

          // 지도 중심 이동 및 확대
          map.setView([lat, lng], 16);

          // 해당 위치 마커 찾기 및 팝업 열기
          markers.forEach(marker => {
            const markerLatLng = marker.getLatLng();
            if (Math.abs(markerLatLng.lat - lat) < 0.0001 && Math.abs(markerLatLng.lng - lng) < 0.0001) {
              marker.openPopup();
            }
          });
          
          console.log(\`🎯 지도 이동: \${name}\`);
        }

        // Leaflet 로드 대기 및 초기화
        function waitForLeaflet() {
          if (typeof L !== 'undefined') {
            console.log('✅ Leaflet 로드 완료');
            initLeafletMap();
            loadFacilitiesData();
          } else {
            console.log('⏳ Leaflet 로딩 중...');
            setTimeout(waitForLeaflet, 100);
          }
        }

        // 페이지 로드 시 Leaflet 로드 대기
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', waitForLeaflet);
        } else {
          waitForLeaflet();
        }
        `
      }} />
    </div>
  )
})

// 관리자 로그인 페이지
app.get('/admin', async (c) => {
  if (await isAdmin(c)) {
    return c.redirect('/admin/dashboard')
  }
  
  return c.render(
    <div class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 to-gray-800">
      <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
        <div class="text-center mb-8">
          <div class="w-20 h-20 bg-gradient-to-r from-gray-800 to-gray-900 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-shield-alt text-3xl text-white"></i>
          </div>
          <h2 class="text-3xl font-bold text-gray-900">관리자 로그인</h2>
          <p class="text-gray-600 mt-2">케어조아 관리 시스템</p>
        </div>

        <form id="adminLoginForm" class="space-y-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fas fa-lock mr-1 text-gray-600"></i>비밀번호
            </label>
            <input 
              type="password" 
              id="password" 
              required 
              class="w-full p-4 border-2 border-gray-300 rounded-lg focus:border-gray-900 focus:outline-none"
              placeholder="관리자 비밀번호를 입력하세요"
            />
          </div>

          <button 
            type="submit" 
            class="w-full bg-gradient-to-r from-gray-800 to-gray-900 text-white py-4 rounded-lg hover:from-gray-900 hover:to-black transform hover:scale-105 transition-all duration-300 font-bold"
          >
            <i class="fas fa-sign-in-alt mr-2"></i>로그인
          </button>
        </form>

        <div class="mt-6 text-center">
          <a href="/" class="text-gray-600 hover:text-gray-900 text-sm">
            <i class="fas fa-arrow-left mr-1"></i>메인 페이지로 돌아가기
          </a>
        </div>
      </div>

      <script dangerouslySetInnerHTML={{
        __html: `
        document.getElementById('adminLoginForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const password = document.getElementById('password').value;
          
          try {
            const response = await axios.post('/api/admin/login', { password });
            if (response.data.success) {
              window.location.href = '/admin/dashboard';
            } else {
              alert(response.data.message || '로그인 실패');
            }
          } catch (error) {
            alert('로그인 중 오류가 발생했습니다.');
          }
        });
        `
      }} />
    </div>
  )
})

// 관리자 대시보드
app.get('/admin/dashboard', async (c) => {
  if (!(await isAdmin(c))) {
    return c.redirect('/admin')
  }
  
  return c.render(
    <div class="min-h-screen bg-gray-100">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
              <i class="fas fa-shield-alt text-2xl text-gray-900 mr-3"></i>
              <h1 class="text-2xl font-bold text-gray-900">케어조아 관리자</h1>
            </div>
            <div class="flex items-center space-x-4">
              <a href="/admin/dashboard" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-home mr-2"></i>대시보드
              </a>
              <a href="/admin/facilities" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-hospital mr-2"></i>시설 관리
              </a>
              <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-sign-out-alt mr-2"></i>로그아웃
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        <div class="grid md:grid-cols-2 gap-8 mb-8">
          <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-blue-100 mb-1">파트너 신청</p>
                <p class="text-4xl font-bold" id="partnerCount">0</p>
              </div>
              <i class="fas fa-handshake text-5xl text-blue-300"></i>
            </div>
          </div>

          <div class="bg-gradient-to-r from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-green-100 mb-1">가족 간병 신청</p>
                <p class="text-4xl font-bold" id="familyCareCount">0</p>
              </div>
              <i class="fas fa-heart text-5xl text-green-300"></i>
            </div>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
          <h3 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-handshake text-blue-600 mr-3"></i>파트너 신청 목록
            <span class="ml-4 text-sm text-gray-500 font-normal">(지역별 대표 상담센터로 지정하려면 체크하세요 - 최대 4개)</span>
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">선택</th>
                  <th class="px-4 py-3 text-left">시설명</th>
                  <th class="px-4 py-3 text-left">유형</th>
                  <th class="px-4 py-3 text-left">시설 주소</th>
                  <th class="px-4 py-3 text-left">담당자</th>
                  <th class="px-4 py-3 text-left">연락처</th>
                  <th class="px-4 py-3 text-left">지역 설정</th>
                  <th class="px-4 py-3 text-left">신청일</th>
                </tr>
              </thead>
              <tbody id="partnerList"></tbody>
            </table>
          </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg p-6">
          <h3 class="text-2xl font-bold mb-6 flex items-center">
            <i class="fas fa-heart text-green-600 mr-3"></i>가족 간병 신청 목록
          </h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left">보호자</th>
                  <th class="px-4 py-3 text-left">연락처</th>
                  <th class="px-4 py-3 text-left">환자명</th>
                  <th class="px-4 py-3 text-left">나이</th>
                  <th class="px-4 py-3 text-left">지역</th>
                  <th class="px-4 py-3 text-left">요청사항</th>
                  <th class="px-4 py-3 text-left">신청일</th>
                </tr>
              </thead>
              <tbody id="familyCareList"></tbody>
            </table>
          </div>
        </div>
      </div>

      {/* Axios CDN - 인라인 스크립트보다 먼저 로드 */}
      <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
      
      <script dangerouslySetInnerHTML={{
        __html: `
        // 지역 데이터
        const regionData = {
          "서울특별시": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
          "부산광역시": ["강서구", "금정구", "기장군", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수영구", "연제구", "영도구", "중구", "해운대구"],
          "대구광역시": ["남구", "달서구", "달성군", "동구", "북구", "서구", "수성구", "중구"],
          "인천광역시": ["강화군", "계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "옹진군", "중구"],
          "광주광역시": ["광산구", "남구", "동구", "북구", "서구"],
          "대전광역시": ["대덕구", "동구", "서구", "유성구", "중구"],
          "울산광역시": ["남구", "동구", "북구", "울주군", "중구"],
          "세종특별자치시": ["세종시"],
          "경기도": ["가평군", "고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "양평군", "여주시", "연천군", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시"],
          "강원도": ["강릉시", "고성군", "동해시", "삼척시", "속초시", "양구군", "양양군", "영월군", "원주시", "인제군", "정선군", "철원군", "춘천시", "태백시", "평창군", "홍천군", "화천군", "횡성군"],
          "충청북도": ["괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "제천시", "증평군", "진천군", "청주시", "충주시"],
          "충청남도": ["계룡시", "공주시", "금산군", "논산시", "당진시", "보령시", "부여군", "서산시", "서천군", "아산시", "예산군", "천안시", "청양군", "태안군", "홍성군"],
          "전라북도": ["고창군", "군산시", "김제시", "남원시", "무주군", "부안군", "순창군", "완주군", "익산시", "임실군", "장수군", "전주시", "정읍시", "진안군"],
          "전라남도": ["강진군", "고흥군", "곡성군", "광양시", "구례군", "나주시", "담양군", "목포시", "무안군", "보성군", "순천시", "신안군", "여수시", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
          "경상북도": ["경산시", "경주시", "고령군", "구미시", "군위군", "김천시", "문경시", "봉화군", "상주시", "성주군", "안동시", "영덕군", "영양군", "영주시", "영천시", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군", "포항시"],
          "경상남도": ["거제시", "거창군", "고성군", "김해시", "남해군", "밀양시", "사천시", "산청군", "양산시", "의령군", "진주시", "창녕군", "창원시", "통영시", "하동군", "함안군", "함양군", "합천군"],
          "제주특별자치도": ["서귀포시", "제주시"]
        };
        
        async function loadData() {
          try {
            const response = await axios.get('/api/admin/data');
            const { partners, familyCare, regionalCenters } = response.data;
            
            document.getElementById('partnerCount').textContent = partners.length;
            document.getElementById('familyCareCount').textContent = familyCare.length;
            
            const partnerList = document.getElementById('partnerList');
            partnerList.innerHTML = partners.map((p, index) => {
              const regionKey = p.regionKey || '';
              const isRegionalCenter = Object.values(regionalCenters).some(centers => 
                centers.some(c => c.id === p.id)
              );
              
              const fullAddress = p.facilitySido && p.facilitySigungu 
                ? \`\${p.facilitySido} \${p.facilitySigungu} \${p.facilityAddress || ''}\`
                : '미입력';
              
              return \`
              <tr class="border-t hover:bg-gray-50" id="partner-\${index}">
                <td class="px-4 py-3">
                  <input type="checkbox" 
                         class="w-5 h-5 text-green-600" 
                         \${isRegionalCenter ? 'checked' : ''}
                         onchange="toggleRegionalCenter(\${index}, '\${p.id}', this.checked)" />
                </td>
                <td class="px-4 py-3">\${p.facilityName}</td>
                <td class="px-4 py-3">\${p.facilityType}</td>
                <td class="px-4 py-3">
                  <div class="text-sm">\${fullAddress}</div>
                </td>
                <td class="px-4 py-3">\${p.managerName}</td>
                <td class="px-4 py-3">\${p.managerPhone}</td>
                <td class="px-4 py-3">
                  <div class="flex gap-2" id="region-selector-\${index}">
                    <select class="text-sm p-2 border rounded" id="sido-\${index}">
                      <option value="">시/도</option>
                    </select>
                    <select class="text-sm p-2 border rounded" id="sigungu-\${index}" disabled>
                      <option value="">시/군/구</option>
                    </select>
                    <button onclick="saveRegion(\${index})" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                      저장
                    </button>
                  </div>
                  <div class="text-sm text-gray-600 mt-1" id="current-region-\${index}">
                    \${regionKey ? regionKey.replace('_', ' > ') : '미설정'}
                  </div>
                </td>
                <td class="px-4 py-3">\${new Date(p.createdAt).toLocaleDateString('ko-KR')}</td>
              </tr>
              \`;
            }).join('') || '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">신청 내역이 없습니다</td></tr>';
            
            // 시도 옵션 생성
            partners.forEach((p, index) => {
              const sidoSelect = document.getElementById('sido-' + index);
              if (sidoSelect) {
                Object.keys(regionData).forEach(sido => {
                  const option = document.createElement('option');
                  option.value = sido;
                  option.textContent = sido;
                  sidoSelect.appendChild(option);
                });
                
                // 시도 변경 이벤트
                sidoSelect.addEventListener('change', function() {
                  const sigunguSelect = document.getElementById('sigungu-' + index);
                  sigunguSelect.innerHTML = '<option value="">시/군/구</option>';
                  sigunguSelect.disabled = false;
                  
                  if (this.value) {
                    regionData[this.value].forEach(sigungu => {
                      const option = document.createElement('option');
                      option.value = sigungu;
                      option.textContent = sigungu;
                      sigunguSelect.appendChild(option);
                    });
                  } else {
                    sigunguSelect.disabled = true;
                  }
                });
              }
            });
            
            const familyCareList = document.getElementById('familyCareList');
            familyCareList.innerHTML = familyCare.map(f => \`
              <tr class="border-t hover:bg-gray-50">
                <td class="px-4 py-3">\${f.guardianName}</td>
                <td class="px-4 py-3">\${f.guardianPhone}</td>
                <td class="px-4 py-3">\${f.patientName}</td>
                <td class="px-4 py-3">\${f.patientAge}세</td>
                <td class="px-4 py-3">\${f.region}</td>
                <td class="px-4 py-3">\${f.requirements || '-'}</td>
                <td class="px-4 py-3">\${new Date(f.createdAt).toLocaleDateString('ko-KR')}</td>
              </tr>
            \`).join('') || '<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">신청 내역이 없습니다</td></tr>';
          } catch (error) {
            console.error('데이터 로드 실패:', error);
          }
        }
        
        // 지역 저장 함수
        window.saveRegion = async function(index) {
          const sido = document.getElementById('sido-' + index).value;
          const sigungu = document.getElementById('sigungu-' + index).value;
          
          if (!sido || !sigungu) {
            alert('시/도와 시/군/구를 모두 선택해주세요.');
            return;
          }
          
          const regionKey = sido + '_' + sigungu;
          
          try {
            const response = await axios.post('/api/admin/set-region', {
              partnerIndex: index,
              regionKey: regionKey
            });
            
            if (response.data.success) {
              alert('지역이 설정되었습니다.');
              loadData();
            }
          } catch (error) {
            alert('지역 설정 실패');
          }
        };
        
        // 대표 상담센터 토글
        window.toggleRegionalCenter = async function(index, partnerId, isChecked) {
          try {
            const response = await axios.post('/api/admin/toggle-regional-center', {
              partnerIndex: index,
              isChecked: isChecked
            });
            
            if (response.data.success) {
              if (!isChecked) {
                alert('대표 상담센터에서 제거되었습니다.');
              } else if (response.data.message) {
                alert(response.data.message);
                loadData(); // 체크 해제를 위해 다시 로드
              } else {
                alert('대표 상담센터로 지정되었습니다. (지역을 설정해주세요)');
              }
            }
          } catch (error) {
            alert('설정 실패');
            loadData();
          }
        };
        
        document.getElementById('logoutBtn').addEventListener('click', async () => {
          try {
            await axios.post('/api/admin/logout');
            window.location.href = '/admin';
          } catch (error) {
            console.error('로그아웃 실패:', error);
          }
        });
        
        loadData();
        setInterval(loadData, 30000);
        `
      }} />
    </div>
  )
})

// ============================================
// 관리자 - 시설 정보 관리 페이지
// ============================================
app.get('/admin/facilities', async (c) => {
  if (!(await isAdmin(c))) {
    return c.redirect('/admin')
  }
  
  return c.render(
    <div class="min-h-screen bg-gray-100">
      <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
              <i class="fas fa-shield-alt text-2xl text-gray-900 mr-3"></i>
              <h1 class="text-2xl font-bold text-gray-900">케어조아 관리자</h1>
            </div>
            <div class="flex items-center space-x-4">
              <a href="/admin/dashboard" class="text-gray-700 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100">
                <i class="fas fa-home mr-2"></i>대시보드
              </a>
              <a href="/admin/facilities" class="bg-gray-200 text-gray-900 px-3 py-2 rounded-lg">
                <i class="fas fa-hospital mr-2"></i>시설 관리
              </a>
              <button id="logoutBtn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                <i class="fas fa-sign-out-alt mr-2"></i>로그아웃
              </button>
            </div>
          </div>
        </div>
      </header>

      <div class="max-w-7xl mx-auto px-4 py-8">
        {/* 상단 통계 및 액션 */}
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
          <div class="flex justify-between items-center mb-6">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-hospital text-blue-600 mr-2"></i>
                요양시설 정보 관리
              </h2>
              <p class="text-gray-600 mt-1">총 <span id="totalCount" class="font-bold text-blue-600">0</span>개 시설</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="downloadExcelBtn" class="bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700">
                <i class="fas fa-download mr-2"></i>엑셀 다운로드
              </button>
              <button id="uploadExcelBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700">
                <i class="fas fa-upload mr-2"></i>엑셀 업로드
              </button>
              <button id="importCsvBtn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
                <i class="fas fa-file-upload mr-2"></i>CSV 임포트
              </button>
              <button id="addFacilityBtn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                <i class="fas fa-plus mr-2"></i>시설 추가
              </button>
            </div>
          </div>

          {/* 검색 필터 */}
          <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="시설명 또는 주소 검색..." 
              class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
            />
            <select id="sidoFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">전체 시도</option>
            </select>
            <select id="sigunguFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">전체 시군구</option>
            </select>
            <select id="typeFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
              <option value="">전체 유형</option>
              <option value="요양병원">요양병원</option>
              <option value="요양원">요양원</option>
              <option value="재가복지센터">재가복지센터</option>
              <option value="주야간보호">주야간보호</option>
            </select>
            <select id="regionalFilter" class="px-4 py-2 border rounded-lg focus:ring-2 focus:ring-teal-500 bg-teal-50">
              <option value="">전체 시설</option>
              <option value="true">대표센터만</option>
              <option value="false">일반시설만</option>
            </select>
            <button id="searchBtn" class="bg-gray-800 text-white px-6 py-2 rounded-lg hover:bg-gray-900">
              <i class="fas fa-search mr-2"></i>검색
            </button>
          </div>
        </div>

        {/* 시설 목록 테이블 */}
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">시설 유형</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">시설명</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">전화번호</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">주소</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">시도</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">시군구</th>
                  <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">대표센터</th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">관리</th>
                </tr>
              </thead>
              <tbody id="facilitiesTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                    <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                    <p>데이터를 불러오는 중...</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {/* 페이지네이션 */}
          <div class="bg-gray-50 px-4 py-3 border-t flex items-center justify-between">
            <div class="text-sm text-gray-700">
              <span id="paginationInfo">페이지 1 / 1</span>
            </div>
            <div class="flex space-x-2" id="paginationButtons">
              <button id="prevPageBtn" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                <i class="fas fa-chevron-left"></i>
              </button>
              <button id="nextPageBtn" class="px-3 py-1 bg-white border rounded hover:bg-gray-50 disabled:opacity-50" disabled>
                <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* 모달 - 시설 추가/수정 */}
      <div id="facilityModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
          <div class="p-6">
            <div class="flex justify-between items-center mb-6">
              <h3 id="modalTitle" class="text-2xl font-bold">시설 추가</h3>
              <button id="closeModalBtn" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
              </button>
            </div>

            <form id="facilityForm" class="space-y-4">
              <input type="hidden" id="facilityId" />
              
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">시설 유형 *</label>
                  <select id="facilityType" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">선택하세요</option>
                    <option value="요양병원">요양병원</option>
                    <option value="요양원">요양원</option>
                    <option value="재가복지센터">재가복지센터</option>
                    <option value="주야간보호">주야간보호</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">시설명 *</label>
                  <input type="text" id="facilityName" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">전화번호</label>
                  <input type="tel" id="facilityPhone" placeholder="02-1234-5678" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">우편번호</label>
                  <input type="text" id="facilityPostalCode" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">주소 *</label>
                <input type="text" id="facilityAddress" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">시도 *</label>
                  <select id="facilitySido" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">선택하세요</option>
                  </select>
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">시군구 *</label>
                  <select id="facilitySigungu" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">선택하세요</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">위도 *</label>
                  <input type="number" id="facilityLatitude" required step="any" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
                
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">경도 *</label>
                  <input type="number" id="facilityLongitude" required step="any" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" />
                </div>
              </div>

              <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="cancelBtn" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                  취소
                </button>
                <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                  <i class="fas fa-save mr-2"></i>저장
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {/* Axios CDN */}
      <script src="https://cdn.jsdelivr.net/npm/axios@1.6.0/dist/axios.min.js"></script>
      
      {/* 간편 견적 폼 처리 스크립트 */}
      <script dangerouslySetInnerHTML={{
        __html: `
        // 간편 견적 폼 제출
        document.addEventListener('DOMContentLoaded', function() {
          const quickEstimateForm = document.getElementById('quickEstimateForm');
          if (quickEstimateForm) {
            quickEstimateForm.addEventListener('submit', async function(e) {
              e.preventDefault();
              
              const name = document.getElementById('quickName').value.trim();
              const phone = document.getElementById('quickPhone').value.trim();
              const region = document.getElementById('quickRegion').value;
              const facilityType = document.getElementById('quickFacilityType').value || '미정';
              
              if (!name || !phone || !region) {
                alert('필수 항목을 모두 입력해주세요.');
                return;
              }
              
              // 전화번호 형식 검증
              const phoneRegex = /^01[0-9]-?[0-9]{3,4}-?[0-9]{4}$/;
              if (!phoneRegex.test(phone)) {
                alert('올바른 전화번호 형식을 입력해주세요. (예: 010-0000-0000)');
                return;
              }
              
              try {
                // 제출 버튼 비활성화
                const submitBtn = quickEstimateForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>처리중...';
                
                // API 호출
                const response = await axios.post('/api/family-care', {
                  guardian_name: name,
                  guardian_phone: phone,
                  patient_name: '환자정보 미입력',
                  patient_age: 0,
                  region: region,
                  requirements: '간편 견적 신청 / 원하는 시설: ' + facilityType
                });
                
                if (response.data.success) {
                  // GA4 이벤트 트래킹
                  if (window.trackEvent) {
                    window.trackEvent('quick_estimate_success', {
                      region: region,
                      facility_type: facilityType
                    });
                  }
                  
                  alert('✅ 견적 신청이 완료되었습니다!\\n\\n전문 상담사가 곧 연락드리겠습니다.\\n감사합니다.');
                  quickEstimateForm.reset();
                } else {
                  throw new Error('신청 실패');
                }
                
                // 버튼 복원
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                
              } catch (error) {
                console.error('견적 신청 오류:', error);
                alert('❌ 신청 중 오류가 발생했습니다.\\n\\n잠시 후 다시 시도해주시거나\\n전화(070-7004-5902)로 문의해주세요.');
                
                // 버튼 복원
                const submitBtn = quickEstimateForm.querySelector('button[type="submit"]');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
              }
            });
          }
        });
        `
      }} />
      
      <script dangerouslySetInnerHTML={{
        __html: `
        // 지역 데이터
        const regionData = {
          "서울특별시": ["강남구", "강동구", "강북구", "강서구", "관악구", "광진구", "구로구", "금천구", "노원구", "도봉구", "동대문구", "동작구", "마포구", "서대문구", "서초구", "성동구", "성북구", "송파구", "양천구", "영등포구", "용산구", "은평구", "종로구", "중구", "중랑구"],
          "부산광역시": ["강서구", "금정구", "기장군", "남구", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "수영구", "연제구", "영도구", "중구", "해운대구"],
          "대구광역시": ["남구", "달서구", "달성군", "동구", "북구", "서구", "수성구", "중구"],
          "인천광역시": ["강화군", "계양구", "남동구", "동구", "미추홀구", "부평구", "서구", "연수구", "옹진군", "중구"],
          "광주광역시": ["광산구", "남구", "동구", "북구", "서구"],
          "대전광역시": ["대덕구", "동구", "서구", "유성구", "중구"],
          "울산광역시": ["남구", "동구", "북구", "울주군", "중구"],
          "세종특별자치시": ["세종시"],
          "경기도": ["가평군", "고양시", "과천시", "광명시", "광주시", "구리시", "군포시", "김포시", "남양주시", "동두천시", "부천시", "성남시", "수원시", "시흥시", "안산시", "안성시", "안양시", "양주시", "양평군", "여주시", "연천군", "오산시", "용인시", "의왕시", "의정부시", "이천시", "파주시", "평택시", "포천시", "하남시", "화성시"],
          "강원도": ["강릉시", "고성군", "동해시", "삼척시", "속초시", "양구군", "양양군", "영월군", "원주시", "인제군", "정선군", "철원군", "춘천시", "태백시", "평창군", "홍천군", "화천군", "횡성군"],
          "충청북도": ["괴산군", "단양군", "보은군", "영동군", "옥천군", "음성군", "제천시", "증평군", "진천군", "청주시", "충주시"],
          "충청남도": ["계룡시", "공주시", "금산군", "논산시", "당진시", "보령시", "부여군", "서산시", "서천군", "아산시", "예산군", "천안시", "청양군", "태안군", "홍성군"],
          "전라북도": ["고창군", "군산시", "김제시", "남원시", "무주군", "부안군", "순창군", "완주군", "익산시", "임실군", "장수군", "전주시", "정읍시", "진안군"],
          "전라남도": ["강진군", "고흥군", "곡성군", "광양시", "구례군", "나주시", "담양군", "목포시", "무안군", "보성군", "순천시", "신안군", "여수시", "영광군", "영암군", "완도군", "장성군", "장흥군", "진도군", "함평군", "해남군", "화순군"],
          "경상북도": ["경산시", "경주시", "고령군", "구미시", "군위군", "김천시", "문경시", "봉화군", "상주시", "성주군", "안동시", "영덕군", "영양군", "영주시", "영천시", "예천군", "울릉군", "울진군", "의성군", "청도군", "청송군", "칠곡군", "포항시"],
          "경상남도": ["거제시", "거창군", "고성군", "김해시", "남해군", "밀양시", "사천시", "산청군", "양산시", "의령군", "진주시", "창녕군", "창원시", "통영시", "하동군", "함안군", "함양군", "합천군"],
          "제주특별자치도": ["서귀포시", "제주시"]
        };

        let currentPage = 1;
        let currentFilters = {};
        let editingFacilityId = null;

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
          loadFacilities();
          initFilters();
          initModals();
          initFormHandlers();
        });

        // 시설 목록 로드
        async function loadFacilities(page = 1) {
          currentPage = page;
          
          const params = new URLSearchParams({
            page,
            limit: 50,
            ...currentFilters
          });

          try {
            const response = await axios.get('/api/admin/facilities?' + params);
            const { facilities, total, totalPages } = response.data;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('paginationInfo').textContent = \`페이지 \${page} / \${totalPages}\`;

            const tbody = document.getElementById('facilitiesTableBody');
            if (facilities.length === 0) {
              tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-8 text-center text-gray-500">등록된 시설이 없습니다.</td></tr>';
              return;
            }

            tbody.innerHTML = facilities.map(f => \`
              <tr class="hover:bg-gray-50">
                <td class="px-4 py-3 text-sm">\${f.id}</td>
                <td class="px-4 py-3">
                  <span class="px-2 py-1 text-xs font-semibold rounded-full \${getTypeColor(f.facility_type)}">
                    \${f.facility_type}
                  </span>
                </td>
                <td class="px-4 py-3 text-sm font-medium">\${f.name}</td>
                <td class="px-4 py-3 text-sm">\${f.phone || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600">\${f.address.substring(0, 30)}\${f.address.length > 30 ? '...' : ''}</td>
                <td class="px-4 py-3 text-sm">\${f.sido}</td>
                <td class="px-4 py-3 text-sm">\${f.sigungu}</td>
                <td class="px-4 py-3 text-center">
                  <button 
                    onclick="toggleRegionalCenter(\${f.id}, '\${f.name}', '\${f.sido}', '\${f.sigungu}', \${f.is_regional_center || false})" 
                    class="px-3 py-1 text-xs font-semibold rounded-full transition-colors \${f.is_regional_center ? 'bg-teal-100 text-teal-800 hover:bg-teal-200' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}"
                    title="\${f.is_regional_center ? '대표센터 지정됨' : '대표센터로 지정하기'}"
                  >
                    \${f.is_regional_center ? '<i class="fas fa-star mr-1"></i>지정됨' : '<i class="far fa-star mr-1"></i>미지정'}
                  </button>
                </td>
                <td class="px-4 py-3 text-sm">
                  <button onclick="editFacility(\${f.id})" class="text-blue-600 hover:text-blue-800 mr-3">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button onclick="deleteFacility(\${f.id}, '\${f.name}')" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-trash"></i>
                  </button>
                </td>
              </tr>
            \`).join('');

            // 페이지네이션 버튼
            document.getElementById('prevPageBtn').disabled = page <= 1;
            document.getElementById('nextPageBtn').disabled = page >= totalPages;
          } catch (error) {
            console.error('Load facilities error:', error);
            alert('시설 목록을 불러오는 중 오류가 발생했습니다.');
          }
        }

        function getTypeColor(type) {
          const colors = {
            '요양병원': 'bg-red-100 text-red-800',
            '요양원': 'bg-blue-100 text-blue-800',
            '재가복지센터': 'bg-green-100 text-green-800',
            '주야간보호': 'bg-yellow-100 text-yellow-800'
          };
          return colors[type] || 'bg-gray-100 text-gray-800';
        }

        // 필터 초기화
        function initFilters() {
          const sidoFilter = document.getElementById('sidoFilter');
          const sidoModal = document.getElementById('facilitySido');
          
          Object.keys(regionData).forEach(sido => {
            sidoFilter.add(new Option(sido, sido));
            sidoModal.add(new Option(sido, sido));
          });

          sidoFilter.addEventListener('change', function() {
            const sigunguFilter = document.getElementById('sigunguFilter');
            sigunguFilter.innerHTML = '<option value="">전체 시군구</option>';
            
            if (this.value && regionData[this.value]) {
              regionData[this.value].forEach(sigungu => {
                sigunguFilter.add(new Option(sigungu, sigungu));
              });
            }
          });

          document.getElementById('facilitySido').addEventListener('change', function() {
            const sigunguModal = document.getElementById('facilitySigungu');
            sigunguModal.innerHTML = '<option value="">선택하세요</option>';
            
            if (this.value && regionData[this.value]) {
              regionData[this.value].forEach(sigungu => {
                sigunguModal.add(new Option(sigungu, sigungu));
              });
            }
          });

          document.getElementById('searchBtn').addEventListener('click', function() {
            currentFilters = {
              search: document.getElementById('searchInput').value,
              sido: document.getElementById('sidoFilter').value,
              sigungu: document.getElementById('sigunguFilter').value,
              type: document.getElementById('typeFilter').value,
              isRegionalCenter: document.getElementById('regionalFilter').value
            };
            loadFacilities(1);
          });

          document.getElementById('prevPageBtn').addEventListener('click', () => loadFacilities(currentPage - 1));
          document.getElementById('nextPageBtn').addEventListener('click', () => loadFacilities(currentPage + 1));
        }

        // 모달 초기화
        function initModals() {
          const modal = document.getElementById('facilityModal');
          
          document.getElementById('addFacilityBtn').addEventListener('click', function() {
            editingFacilityId = null;
            document.getElementById('modalTitle').textContent = '시설 추가';
            document.getElementById('facilityForm').reset();
            modal.classList.remove('hidden');
          });

          document.getElementById('closeModalBtn').addEventListener('click', () => modal.classList.add('hidden'));
          document.getElementById('cancelBtn').addEventListener('click', () => modal.classList.add('hidden'));
        }

        // 폼 핸들러
        function initFormHandlers() {
          document.getElementById('facilityForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const data = {
              facility_type: document.getElementById('facilityType').value,
              name: document.getElementById('facilityName').value,
              phone: document.getElementById('facilityPhone').value,
              postal_code: document.getElementById('facilityPostalCode').value,
              address: document.getElementById('facilityAddress').value,
              sido: document.getElementById('facilitySido').value,
              sigungu: document.getElementById('facilitySigungu').value,
              latitude: parseFloat(document.getElementById('facilityLatitude').value),
              longitude: parseFloat(document.getElementById('facilityLongitude').value)
            };

            try {
              if (editingFacilityId) {
                await axios.put(\`/api/admin/facilities/\${editingFacilityId}\`, data);
                alert('시설 정보가 수정되었습니다.');
              } else {
                await axios.post('/api/admin/facilities', data);
                alert('시설이 추가되었습니다.');
              }
              
              document.getElementById('facilityModal').classList.add('hidden');
              loadFacilities(currentPage);
            } catch (error) {
              console.error('Save facility error:', error);
              alert('저장 중 오류가 발생했습니다.');
            }
          });

          // 엑셀 다운로드
          document.getElementById('downloadExcelBtn').addEventListener('click', async function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>다운로드 중...';
            
            try {
              // 현재 필터 조건으로 모든 시설 데이터 가져오기
              const params = new URLSearchParams({
                page: '1',
                limit: '100000', // 모든 데이터
                search: currentFilters.search || '',
                sido: currentFilters.sido || '',
                sigungu: currentFilters.sigungu || '',
                type: currentFilters.type || ''
              });
              
              const response = await axios.get(\`/api/admin/facilities?\${params}\`);
              const facilities = response.data.facilities;
              
              if (facilities.length === 0) {
                alert('다운로드할 시설이 없습니다.');
                return;
              }
              
              // CSV 형식으로 변환
              const headers = ['ID', '시설유형', '시설명', '우편번호', '주소', '전화번호', '위도', '경도', '시도', '시군구', '비고'];
              const csvRows = [headers.join(',')];
              
              facilities.forEach(f => {
                const row = [
                  f.id,
                  f.facility_type,
                  \`"\${f.name}"\`,
                  f.postal_code || '',
                  \`"\${f.address}"\`,
                  f.phone || '',
                  f.latitude,
                  f.longitude,
                  f.sido,
                  f.sigungu,
                  \`"\${f.notes || ''}"\`
                ];
                csvRows.push(row.join(','));
              });
              
              // CSV 파일 다운로드
              const csvContent = '\\uFEFF' + csvRows.join('\\n'); // UTF-8 BOM 추가 (엑셀 한글 깨짐 방지)
              const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);
              
              const filename = \`facilities_\${new Date().toISOString().split('T')[0]}.csv\`;
              link.setAttribute('href', url);
              link.setAttribute('download', filename);
              link.style.display = 'none';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              
              alert(\`\${facilities.length}개 시설 데이터가 다운로드되었습니다.\\n파일명: \${filename}\`);
            } catch (error) {
              console.error('Download error:', error);
              alert('다운로드 중 오류가 발생했습니다.');
            } finally {
              this.disabled = false;
              this.innerHTML = '<i class="fas fa-download mr-2"></i>엑셀 다운로드';
            }
          });

          // 엑셀 업로드
          document.getElementById('uploadExcelBtn').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv,.xlsx,.xls';
            
            fileInput.onchange = async function(e) {
              const file = e.target.files[0];
              if (!file) return;
              
              if (!confirm(\`\${file.name} 파일을 업로드하여 시설 정보를 업데이트하시겠습니까?\\n\\n주의: 동일한 ID가 있으면 덮어쓰기됩니다.\`)) {
                return;
              }
              
              const btn = document.getElementById('uploadExcelBtn');
              btn.disabled = true;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>업로드 중...';
              
              try {
                const reader = new FileReader();
                
                reader.onload = async function(event) {
                  try {
                    const text = event.target.result;
                    const lines = text.split('\\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                      alert('파일에 데이터가 없습니다.');
                      return;
                    }
                    
                    // 헤더 확인 (첫 번째 줄 건너뛰기)
                    const facilities = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                      const cols = parseCSVLine(lines[i]);
                      if (cols.length < 10) continue;
                      
                      const [id, facilityType, name, postalCode, address, phone, lat, lng, sido, sigungu, notes] = cols;
                      
                      facilities.push({
                        id: parseInt(id) || null,
                        facility_type: facilityType.replace(/^"|"$/g, ''),
                        name: name.replace(/^"|"$/g, ''),
                        postal_code: postalCode.replace(/^"|"$/g, ''),
                        address: address.replace(/^"|"$/g, ''),
                        phone: phone.replace(/^"|"$/g, ''),
                        latitude: parseFloat(lat) || 0,
                        longitude: parseFloat(lng) || 0,
                        sido: sido.replace(/^"|"$/g, ''),
                        sigungu: sigungu.replace(/^"|"$/g, ''),
                        notes: notes ? notes.replace(/^"|"$/g, '') : ''
                      });
                    }
                    
                    if (facilities.length === 0) {
                      alert('유효한 시설 데이터가 없습니다.');
                      return;
                    }
                    
                    // 서버로 전송
                    const response = await axios.post('/api/admin/upload-facilities', { facilities });
                    
                    if (response.data.success) {
                      alert(\`업로드 완료!\\n업데이트: \${response.data.updated}개\\n신규추가: \${response.data.inserted}개\\n실패: \${response.data.failed}개\`);
                      loadFacilities(1);
                    }
                  } catch (error) {
                    console.error('Parse error:', error);
                    alert('파일 파싱 중 오류가 발생했습니다.');
                  }
                };
                
                reader.readAsText(file, 'UTF-8');
              } catch (error) {
                console.error('Upload error:', error);
                alert('업로드 중 오류가 발생했습니다.');
              } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-upload mr-2"></i>엑셀 업로드';
              }
            };
            
            fileInput.click();
          });

          // DB 초기화
          // CSV 임포트
          document.getElementById('importCsvBtn').addEventListener('click', async function() {
            // 파일 입력 생성
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.csv';
            
            fileInput.onchange = async (e) => {
              const file = e.target.files[0];
              if (!file) return;
              
              if (!confirm(\`📄 파일: \${file.name}\\n크기: \${(file.size / 1024 / 1024).toFixed(2)}MB\\n\\nCSV 데이터를 임포트하시겠습니까?\\n(진행 상황이 표시됩니다)\`)) return;
              
              const btn = document.getElementById('importCsvBtn');
              btn.disabled = true;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>파일 읽는 중...';
              
              try {
                // 파일 읽기
                const text = await file.text();
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>데이터 파싱 중...';
                
                // CSV 파싱
                const lines = text.split('\\n').filter(line => line.trim());
                const facilities = [];
                
                for (let i = 1; i < lines.length; i++) {
                  const cols = parseCSVLine(lines[i]);
                  if (cols.length < 9) continue;
                  
                  const facilityType = cols[0] || cols[1];
                  const name = cols[1] || cols[2];
                  const postalCode = cols[2] || cols[3];
                  const address = cols[3] || cols[4];
                  const phone = cols[4] || cols[5] || '';
                  const lat = cols[5] || cols[6];
                  const lng = cols[6] || cols[7];
                  const sido = cols[7] || cols[8];
                  const sigungu = cols[8] || cols[9];
                  
                  const latitude = parseFloat(lat);
                  const longitude = parseFloat(lng);
                  
                  if (!name || !address || !sido || !sigungu) continue;
                  
                  facilities.push({
                    facility_type: String(facilityType).replace(/^"|"$/g, '').trim(),
                    name: String(name).replace(/^"|"$/g, '').trim(),
                    postal_code: String(postalCode).replace(/^"|"$/g, '').trim(),
                    address: String(address).replace(/^"|"$/g, '').trim(),
                    phone: String(phone).replace(/^"|"$/g, '').trim(),
                    latitude: isNaN(latitude) ? 0 : latitude,
                    longitude: isNaN(longitude) ? 0 : longitude,
                    sido: String(sido).replace(/^"|"$/g, '').trim(),
                    sigungu: String(sigungu).replace(/^"|"$/g, '').trim()
                  });
                }
                
                if (facilities.length === 0) {
                  alert('❌ 유효한 시설 데이터가 없습니다.');
                  return;
                }
                
                btn.innerHTML = \`<i class="fas fa-upload mr-2"></i>0 / \${facilities.length} 업로드 중...\`;
                
                // 배치 업로드 (100개씩)
                const BATCH_SIZE = 100;
                let successCount = 0;
                let errorCount = 0;
                
                for (let i = 0; i < facilities.length; i += BATCH_SIZE) {
                  const batch = facilities.slice(i, i + BATCH_SIZE);
                  
                  try {
                    const response = await axios.post('/api/admin/import-csv', { facilities: batch });
                    
                    if (response.data.success) {
                      successCount += response.data.successCount || batch.length;
                      errorCount += response.data.errorCount || 0;
                    } else {
                      errorCount += batch.length;
                    }
                  } catch (error) {
                    console.error('Batch upload error:', error);
                    errorCount += batch.length;
                  }
                  
                  // 진행 상황 업데이트
                  const progress = Math.min(i + batch.length, facilities.length);
                  const percentage = Math.round((progress / facilities.length) * 100);
                  btn.innerHTML = \`<i class="fas fa-upload mr-2"></i>\${progress} / \${facilities.length} (\${percentage}%)\`;
                }
                
                alert(\`✅ 임포트 완료!\\n\\n성공: \${successCount.toLocaleString()}개\\n실패: \${errorCount.toLocaleString()}개\\n전체: \${facilities.length.toLocaleString()}개\`);
                loadFacilities(1);
                
              } catch (error) {
                console.error('Import CSV error:', error);
                alert('❌ CSV 임포트 중 오류가 발생했습니다.');
              } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-upload mr-2"></i>CSV 임포트';
              }
            };
            
            fileInput.click();
          });

          // 요양병원 교체 (엑셀 파일 업로드)
          // 로그아웃
          document.getElementById('logoutBtn').addEventListener('click', async function() {
            try {
              await axios.post('/api/admin/logout');
              window.location.href = '/admin';
            } catch (error) {
              window.location.href = '/admin';
            }
          });
        }

        // CSV 파싱 함수
        function parseCSVLine(line) {
          const result = [];
          let current = '';
          let inQuotes = false;
          
          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              result.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          
          result.push(current.trim());
          return result;
        }

        // 시설 편집
        async function editFacility(id) {
          try {
            const response = await axios.get(\`/api/admin/facilities/\${id}\`);
            const facility = response.data.facility;
            
            editingFacilityId = id;
            document.getElementById('modalTitle').textContent = '시설 수정';
            
            document.getElementById('facilityId').value = facility.id;
            document.getElementById('facilityType').value = facility.facility_type;
            document.getElementById('facilityName').value = facility.name;
            document.getElementById('facilityPhone').value = facility.phone || '';
            document.getElementById('facilityPostalCode').value = facility.postal_code || '';
            document.getElementById('facilityAddress').value = facility.address;
            document.getElementById('facilitySido').value = facility.sido;
            
            // 시군구 로드
            const sigunguSelect = document.getElementById('facilitySigungu');
            sigunguSelect.innerHTML = '<option value="">선택하세요</option>';
            if (regionData[facility.sido]) {
              regionData[facility.sido].forEach(sigungu => {
                sigunguSelect.add(new Option(sigungu, sigungu));
              });
            }
            sigunguSelect.value = facility.sigungu;
            
            document.getElementById('facilityLatitude').value = facility.latitude;
            document.getElementById('facilityLongitude').value = facility.longitude;
            
            document.getElementById('facilityModal').classList.remove('hidden');
          } catch (error) {
            console.error('Load facility error:', error);
            alert('시설 정보를 불러오는 중 오류가 발생했습니다.');
          }
        }

        // 시설 삭제
        async function deleteFacility(id, name) {
          if (!confirm(\`"\${name}" 시설을 삭제하시겠습니까?\`)) return;
          
          try {
            await axios.delete(\`/api/admin/facilities/\${id}\`);
            alert('시설이 삭제되었습니다.');
            loadFacilities(currentPage);
          } catch (error) {
            console.error('Delete facility error:', error);
            alert('시설 삭제 중 오류가 발생했습니다.');
          }
        }

        // 대표 상담센터 지정/해제
        async function toggleRegionalCenter(facilityId, facilityName, sido, sigungu, isCurrentlyRegional) {
          const regionKey = \`\${sido}_\${sigungu}\`;
          
          if (isCurrentlyRegional) {
            // 대표센터 해제
            if (!confirm(\`"\${facilityName}"을(를) 대표 상담센터에서 해제하시겠습니까?\`)) return;
            
            try {
              const response = await axios.post('/api/admin/facilities/toggle-regional-center', {
                facilityId,
                regionKey,
                isRegionalCenter: false
              });
              
              if (response.data.success) {
                alert('대표 상담센터에서 해제되었습니다.');
                loadFacilities(currentPage);
              } else {
                alert(response.data.message || '해제 실패');
              }
            } catch (error) {
              console.error('Toggle regional center error:', error);
              alert('대표센터 해제 중 오류가 발생했습니다.');
            }
          } else {
            // 대표센터 지정
            if (!confirm(\`"\${facilityName}"을(를) \${sido} \${sigungu}의 대표 상담센터로 지정하시겠습니까?\\n\\n※ 한 지역당 최대 4개까지 지정 가능합니다.\`)) return;
            
            try {
              const response = await axios.post('/api/admin/facilities/toggle-regional-center', {
                facilityId,
                regionKey,
                isRegionalCenter: true
              });
              
              if (response.data.success) {
                alert('대표 상담센터로 지정되었습니다.');
                loadFacilities(currentPage);
              } else {
                alert(response.data.message || '지정 실패');
              }
            } catch (error) {
              console.error('Toggle regional center error:', error);
              alert('대표센터 지정 중 오류가 발생했습니다.');
            }
          }
        }
        `
      }} />
    </div>
  )
})

// API 라우트
app.post('/api/partner', async (c) => {
  try {
    const { DB } = c.env
    const data = await c.req.json()
    const partnerId = 'partner_' + Date.now() + '_' + Math.random().toString(36).substring(2)
    const createdAt = new Date().toISOString()
    
    // 자동으로 region_key 생성 (시도_시군구 형식)
    const regionKey = (data.facilitySido && data.facilitySigungu) 
      ? `${data.facilitySido}_${data.facilitySigungu}` 
      : ''
    
    await DB.prepare(`
      INSERT INTO partners (
        id, facility_name, facility_type, facility_sido, facility_sigungu, 
        facility_address, manager_name, manager_phone, region_key, 
        is_regional_center, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      partnerId,
      data.facilityName,
      data.facilityType,
      data.facilitySido || null,
      data.facilitySigungu || null,
      data.facilityAddress || null,
      data.managerName,
      data.managerPhone,
      regionKey, // 자동 생성된 region_key
      0, // is_regional_center default false
      createdAt
    ).run()
    
    return c.json({ success: true, message: '파트너 등록이 완료되었습니다!' })
  } catch (error) {
    console.error('Partner registration error:', error)
    return c.json({ success: false, message: '등록 실패' }, 500)
  }
})

app.post('/api/family-care', async (c) => {
  try {
    const { DB } = c.env
    const data = await c.req.json()
    const familyCareId = 'family_' + Date.now() + '_' + Math.random().toString(36).substring(2)
    const createdAt = new Date().toISOString()
    
    await DB.prepare(`
      INSERT INTO family_care (
        id, guardian_name, guardian_phone, patient_name, patient_age, 
        region, requirements, created_at
      ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      familyCareId,
      data.guardianName,
      data.guardianPhone,
      data.patientName,
      parseInt(data.patientAge),
      data.region,
      data.requirements || null,
      createdAt
    ).run()
    
    return c.json({ success: true, message: '가족 간병 신청이 완료되었습니다!' })
  } catch (error) {
    console.error('Family care registration error:', error)
    return c.json({ success: false, message: '신청 실패' }, 500)
  }
})

app.post('/api/admin/login', async (c) => {
  try {
    const { DB } = c.env
    const { password } = await c.req.json()
    
    // admin_sessions 테이블이 없으면 생성
    try {
      await DB.prepare(`
        CREATE TABLE IF NOT EXISTS admin_sessions (
          session_id TEXT PRIMARY KEY,
          created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
          expires_at DATETIME NOT NULL
        )
      `).run()
    } catch (err) {
      console.log('Table creation skipped or already exists')
    }
    
    if (password === c.env.ADMIN_PASSWORD) {
      const sessionId = generateSessionId()
      const createdAt = new Date().toISOString()
      const expiresAt = new Date(Date.now() + 3600 * 1000).toISOString() // 1시간 후
      
      await DB.prepare(`
        INSERT INTO admin_sessions (session_id, created_at, expires_at)
        VALUES (?, ?, ?)
      `).bind(sessionId, createdAt, expiresAt).run()
      
      setCookie(c, ADMIN_CONFIG.sessionKey, sessionId, {
        httpOnly: true,
        maxAge: 3600
      })
      return c.json({ success: true })
    }
    return c.json({ success: false, message: '비밀번호가 올바르지 않습니다.' }, 401)
  } catch (error) {
    console.error('Admin login error:', error)
    return c.json({ success: false, message: '로그인 실패' }, 500)
  }
})

app.post('/api/admin/logout', async (c) => {
  try {
    const { DB } = c.env
    const sessionId = getCookie(c, ADMIN_CONFIG.sessionKey)
    if (sessionId) {
      await DB.prepare('DELETE FROM admin_sessions WHERE session_id = ?')
        .bind(sessionId).run()
    }
    setCookie(c, ADMIN_CONFIG.sessionKey, '', { maxAge: 0 })
    return c.json({ success: true })
  } catch (error) {
    console.error('Admin logout error:', error)
    return c.json({ success: true }) // 로그아웃은 항상 성공으로 처리
  }
})

app.get('/api/admin/data', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    
    // Partners 데이터 조회
    const partnersResult = await DB.prepare(
      'SELECT * FROM partners ORDER BY created_at DESC'
    ).all()
    
    // Family care 데이터 조회
    const familyCareResult = await DB.prepare(
      'SELECT * FROM family_care ORDER BY created_at DESC'
    ).all()
    
    // Regional centers 데이터 조회
    const regionalCentersResult = await DB.prepare(
      'SELECT * FROM regional_centers ORDER BY created_at DESC'
    ).all()
    
    // Partners 데이터를 frontend 형식으로 변환
    const partners = partnersResult.results.map((p: any) => ({
      id: p.id,
      facilityName: p.facility_name,
      facilityType: p.facility_type,
      facilitySido: p.facility_sido,
      facilitySigungu: p.facility_sigungu,
      facilityAddress: p.facility_address,
      managerName: p.manager_name,
      managerPhone: p.manager_phone,
      regionKey: p.region_key,
      isRegionalCenter: p.is_regional_center === 1,
      createdAt: p.created_at
    }))
    
    // Family care 데이터를 frontend 형식으로 변환
    const familyCare = familyCareResult.results.map((f: any) => ({
      id: f.id,
      guardianName: f.guardian_name,
      guardianPhone: f.guardian_phone,
      patientName: f.patient_name,
      patientAge: f.patient_age,
      region: f.region,
      requirements: f.requirements,
      createdAt: f.created_at
    }))
    
    // Regional centers를 regionKey별로 그룹화
    const regionalCenters: Record<string, any[]> = {}
    regionalCentersResult.results.forEach((rc: any) => {
      if (!regionalCenters[rc.region_key]) {
        regionalCenters[rc.region_key] = []
      }
      regionalCenters[rc.region_key].push({
        id: rc.partner_id,
        facilityName: rc.facility_name,
        facilityType: rc.facility_type,
        managerName: rc.manager_name,
        managerPhone: rc.manager_phone
      })
    })
    
    return c.json({ partners, familyCare, regionalCenters })
  } catch (error) {
    console.error('Admin data fetch error:', error)
    return c.json({ error: 'Data fetch failed' }, 500)
  }
})

// 지역 설정 API
app.post('/api/admin/set-region', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const { partnerIndex, regionKey } = await c.req.json()
    
    // 모든 파트너 조회 (순서 유지를 위해)
    const partnersResult = await DB.prepare(
      'SELECT id FROM partners ORDER BY created_at DESC'
    ).all()
    
    if (partnerIndex >= 0 && partnerIndex < partnersResult.results.length) {
      const partnerId = partnersResult.results[partnerIndex].id
      
      await DB.prepare(
        'UPDATE partners SET region_key = ?, updated_at = ? WHERE id = ?'
      ).bind(regionKey, new Date().toISOString(), partnerId).run()
      
      return c.json({ success: true })
    }
    return c.json({ success: false, message: '파트너를 찾을 수 없습니다.' }, 404)
  } catch (error) {
    console.error('Set region error:', error)
    return c.json({ success: false, message: '설정 실패' }, 500)
  }
})

// 대표 상담센터 토글 API
app.post('/api/admin/toggle-regional-center', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const { partnerIndex, isChecked } = await c.req.json()
    
    // 모든 파트너 조회 (순서 유지를 위해)
    const partnersResult = await DB.prepare(
      'SELECT * FROM partners ORDER BY created_at DESC'
    ).all()
    
    if (partnerIndex < 0 || partnerIndex >= partnersResult.results.length) {
      return c.json({ success: false, message: '파트너를 찾을 수 없습니다.' }, 404)
    }
    
    const partner: any = partnersResult.results[partnerIndex]
    const regionKey = partner.region_key
    
    if (isChecked) {
      // 체크: 대표 상담센터로 추가
      if (!regionKey) {
        return c.json({ success: true, message: '먼저 지역을 설정해주세요.' })
      }
      
      // 해당 지역의 대표 상담센터 개수 확인
      const countResult = await DB.prepare(
        'SELECT COUNT(*) as count FROM regional_centers WHERE region_key = ?'
      ).bind(regionKey).first()
      
      if (countResult && (countResult.count as number) >= 4) {
        return c.json({ 
          success: false, 
          message: '해당 지역은 이미 4개의 대표 상담센터가 등록되어 있습니다. 다른 센터를 제거한 후 추가해주세요.' 
        })
      }
      
      // 중복 체크
      const existsResult = await DB.prepare(
        'SELECT id FROM regional_centers WHERE region_key = ? AND partner_id = ?'
      ).bind(regionKey, partner.id).first()
      
      if (!existsResult) {
        // Regional centers 테이블에 추가
        await DB.prepare(`
          INSERT INTO regional_centers (
            region_key, partner_id, facility_name, facility_type, 
            manager_name, manager_phone, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?)
        `).bind(
          regionKey,
          partner.id,
          partner.facility_name,
          partner.facility_type,
          partner.manager_name,
          partner.manager_phone,
          new Date().toISOString()
        ).run()
        
        // Partners 테이블의 is_regional_center 플래그 업데이트
        await DB.prepare(
          'UPDATE partners SET is_regional_center = 1, updated_at = ? WHERE id = ?'
        ).bind(new Date().toISOString(), partner.id).run()
      }
    } else {
      // 체크 해제: 대표 상담센터에서 제거
      if (regionKey) {
        await DB.prepare(
          'DELETE FROM regional_centers WHERE region_key = ? AND partner_id = ?'
        ).bind(regionKey, partner.id).run()
        
        // Partners 테이블의 is_regional_center 플래그 업데이트
        await DB.prepare(
          'UPDATE partners SET is_regional_center = 0, updated_at = ? WHERE id = ?'
        ).bind(new Date().toISOString(), partner.id).run()
      }
    }
    
    return c.json({ success: true })
  } catch (error) {
    console.error('Toggle regional center error:', error)
    return c.json({ success: false, message: '설정 실패' }, 500)
  }
})

// 지역별 상담센터 디버깅 API (관리자 전용)
app.get('/api/admin/debug-regional-centers', async (c) => {
  const adminPassword = c.req.header('X-Admin-Password')
  if (adminPassword !== c.env.ADMIN_PASSWORD) {
    return c.json({ success: false, error: 'Unauthorized' }, 401)
  }

  try {
    const { DB } = c.env
    
    // 전체 regional_centers 데이터 샘플 조회
    const allCenters = await DB.prepare(
      'SELECT * FROM regional_centers LIMIT 10'
    ).all()
    
    // 총 개수
    const countResult = await DB.prepare(
      'SELECT COUNT(*) as total FROM regional_centers'
    ).first()
    
    // 고유 region_key 샘플
    const uniqueRegions = await DB.prepare(
      'SELECT DISTINCT region_key FROM regional_centers LIMIT 20'
    ).all()
    
    return c.json({
      success: true,
      total_centers: countResult.total,
      sample_centers: allCenters.results,
      sample_regions: uniqueRegions.results
    })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 지역별 상담센터 조회 API
app.get('/api/regional-centers', async (c) => {
  const region = c.req.query('region')
  
  console.log('[Regional Centers API] Requested region:', region)
  
  if (!region) {
    console.log('[Regional Centers API] No region provided')
    return c.json({ centers: [], debug: 'no_region' })
  }
  
  try {
    const { DB } = c.env
    console.log('[Regional Centers API] Querying DB for region:', region)
    
    const centersResult = await DB.prepare(
      'SELECT * FROM regional_centers WHERE region_key = ? ORDER BY created_at ASC LIMIT 4'
    ).bind(region).all()
    
    console.log('[Regional Centers API] Query results:', centersResult.results.length, 'centers found')
    
    const centers = centersResult.results.map((rc: any) => ({
      facilityName: rc.facility_name,
      facilityType: rc.facility_type,
      managerName: rc.manager_name,
      managerPhone: rc.manager_phone
    }))
    
    console.log('[Regional Centers API] Returning centers:', centers.length)
    return c.json({ centers, debug: { region, count: centers.length } })
  } catch (error: any) {
    console.error('[Regional Centers API] Error:', error)
    return c.json({ centers: [], debug: { error: error.message } })
  }
})

// ============================================
// 관리자 API - 시설 정보 CRUD
// ============================================

// 데이터베이스 초기화 (테이블 생성)
app.post('/api/admin/init-db', async (c) => {
  try {
    const { DB } = c.env
    
    console.log('🔧 데이터베이스 초기화 시작...')
    
    // 1. admin_sessions 테이블 생성
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS admin_sessions (
        session_id TEXT PRIMARY KEY,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        expires_at DATETIME NOT NULL
      )
    `).run()
    console.log('✅ admin_sessions 테이블 생성')
    
    // 2. partners 테이블 생성 (파트너 신청)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS partners (
        id TEXT PRIMARY KEY,
        facility_name TEXT NOT NULL,
        facility_type TEXT NOT NULL,
        facility_sido TEXT,
        facility_sigungu TEXT,
        facility_address TEXT,
        manager_name TEXT NOT NULL,
        manager_phone TEXT NOT NULL,
        region_key TEXT,
        is_regional_center INTEGER DEFAULT 0,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    console.log('✅ partners 테이블 생성')
    
    // 3. family_care 테이블 생성 (가족 간병 신청)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS family_care (
        id TEXT PRIMARY KEY,
        guardian_name TEXT NOT NULL,
        guardian_phone TEXT NOT NULL,
        patient_name TEXT NOT NULL,
        patient_age INTEGER,
        region TEXT,
        requirements TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    console.log('✅ family_care 테이블 생성')
    
    // 4. regional_centers 테이블 생성 (지역별 대표 상담센터)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS regional_centers (
        id TEXT PRIMARY KEY,
        region_key TEXT NOT NULL,
        partner_id TEXT NOT NULL,
        facility_id INTEGER,
        facility_name TEXT NOT NULL,
        facility_type TEXT NOT NULL,
        manager_name TEXT NOT NULL,
        manager_phone TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    console.log('✅ regional_centers 테이블 생성')
    
    // regional_centers 테이블에 facility_id 컬럼 추가 (기존 테이블용)
    try {
      await DB.prepare(`ALTER TABLE regional_centers ADD COLUMN facility_id INTEGER`).run()
      console.log('✅ regional_centers 테이블에 facility_id 컬럼 추가됨')
    } catch (error) {
      // 컬럼이 이미 존재하면 에러 무시
      console.log('ℹ️ regional_centers.facility_id 컬럼이 이미 존재합니다')
    }
    
    // 5. facilities 테이블 생성 (요양시설 정보)
    await DB.prepare(`
      CREATE TABLE IF NOT EXISTS facilities (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        facility_type TEXT NOT NULL,
        name TEXT NOT NULL,
        postal_code TEXT,
        address TEXT NOT NULL,
        phone TEXT,
        latitude REAL NOT NULL,
        longitude REAL NOT NULL,
        sido TEXT NOT NULL,
        sigungu TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `).run()
    console.log('✅ facilities 테이블 생성')
    
    // 인덱스 생성
    await DB.prepare('CREATE INDEX IF NOT EXISTS idx_facilities_sido ON facilities(sido)').run()
    await DB.prepare('CREATE INDEX IF NOT EXISTS idx_facilities_sigungu ON facilities(sigungu)').run()
    await DB.prepare('CREATE INDEX IF NOT EXISTS idx_facilities_type ON facilities(facility_type)').run()
    await DB.prepare('CREATE INDEX IF NOT EXISTS idx_partners_region ON partners(region_key)').run()
    await DB.prepare('CREATE INDEX IF NOT EXISTS idx_regional_centers_region ON regional_centers(region_key)').run()
    console.log('✅ 인덱스 생성 완료')
    
    console.log('🎉 데이터베이스 초기화 완료!')
    return c.json({ 
      success: true, 
      message: '데이터베이스 초기화 완료 (5개 테이블 생성)',
      tables: ['admin_sessions', 'partners', 'family_care', 'regional_centers', 'facilities']
    })
  } catch (error: any) {
    console.error('❌ 데이터베이스 초기화 실패:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// CSV 데이터 일괄 임포트
app.post('/api/admin/import-csv', async (c) => {
  try {
    const { facilities } = await c.req.json()
    const { DB } = c.env
    
    if (!Array.isArray(facilities) || facilities.length === 0) {
      return c.json({ success: false, error: '유효한 시설 데이터가 없습니다' }, 400)
    }
    
    console.log(`Starting import of ${facilities.length} facilities...`)
    let imported = 0
    let failed = 0
    
    // D1 batch API를 사용한 대량 INSERT (훨씬 빠름)
    // 500개씩 배치 처리
    for (let i = 0; i < facilities.length; i += 500) {
      const batch = facilities.slice(i, i + 500)
      const statements = []
      
      for (const facility of batch) {
        try {
          statements.push(
            DB.prepare(`
              INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu)
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
            `).bind(
              facility.facilityType,
              facility.name,
              facility.postalCode || '',
              facility.address,
              facility.phone || '',
              facility.latitude,
              facility.longitude,
              facility.sido,
              facility.sigungu
            )
          )
        } catch (err) {
          console.error('Prepare error:', err)
          failed++
        }
      }
      
      // 배치 실행
      try {
        await DB.batch(statements)
        imported += statements.length
        console.log(`Batch ${Math.floor(i/500) + 1}: Imported ${statements.length} facilities (Total: ${imported})`)
      } catch (err) {
        console.error('Batch import error:', err)
        failed += statements.length
      }
    }
    
    console.log(`Import completed: ${imported} success, ${failed} failed`)
    return c.json({ success: true, imported, failed, total: facilities.length })
  } catch (error: any) {
    console.error('Import CSV error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 지역별 대표시설 자동 지정 API
app.post('/api/admin/auto-assign-regional-centers', async (c) => {
  const adminPassword = c.req.header('X-Admin-Password')
  if (adminPassword !== c.env.ADMIN_PASSWORD) {
    return c.json({ success: false, error: 'Unauthorized' }, 401)
  }

  try {
    const { DB } = c.env
    
    // 각 시도/시군구/유형별로 첫 번째 시설을 대표시설로 지정
    const insertResult = await DB.prepare(`
      INSERT INTO regional_centers (id, region_key, partner_id, facility_id, facility_name, facility_type, manager_name, manager_phone, created_at)
      SELECT 
        'rc_' || f.sido || '_' || f.sigungu || '_' || f.facility_type || '_' || f.id as id,
        f.sido || '_' || f.sigungu as region_key,
        'partner_auto_' || f.id as partner_id,
        f.id as facility_id,
        f.name as facility_name,
        f.facility_type,
        '자동지정' as manager_name,
        '000-0000-0000' as manager_phone,
        CURRENT_TIMESTAMP as created_at
      FROM facilities f
      WHERE f.id IN (
        SELECT MIN(id)
        FROM facilities
        WHERE sido IS NOT NULL 
          AND sigungu IS NOT NULL 
          AND facility_type IN ('요양병원', '요양원', '재가복지센터', '주야간보호')
        GROUP BY sido, sigungu, facility_type
      )
      AND f.id NOT IN (SELECT facility_id FROM regional_centers WHERE facility_id IS NOT NULL)
    `).run()
    
    // 결과 통계 조회
    const statsResult = await DB.prepare(`
      SELECT 
        COUNT(*) as total,
        COUNT(DISTINCT region_key) as regions,
        SUM(CASE WHEN facility_type = '요양병원' THEN 1 ELSE 0 END) as hospitals,
        SUM(CASE WHEN facility_type = '요양원' THEN 1 ELSE 0 END) as nursing_homes,
        SUM(CASE WHEN facility_type = '재가복지센터' THEN 1 ELSE 0 END) as home_care,
        SUM(CASE WHEN facility_type = '주야간보호' THEN 1 ELSE 0 END) as day_care
      FROM regional_centers
      WHERE facility_id IS NOT NULL
    `).first()
    
    return c.json({ 
      success: true, 
      inserted: insertResult.meta.changes,
      stats: statsResult
    })
  } catch (error: any) {
    console.error('Auto-assign regional centers error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 목록 조회 (페이징, 검색)
app.get('/api/admin/facilities', async (c) => {
  try {
    const { DB } = c.env
    const page = parseInt(c.req.query('page') || '1')
    const limit = parseInt(c.req.query('limit') || '50')
    const search = c.req.query('search') || ''
    const sido = c.req.query('sido') || ''
    const sigungu = c.req.query('sigungu') || ''
    const type = c.req.query('type') || ''
    const isRegionalCenter = c.req.query('isRegionalCenter') || ''
    
    const offset = (page - 1) * limit
    
    let whereClause = '1=1'
    const bindings: any[] = []
    
    if (search) {
      whereClause += ' AND (f.name LIKE ? OR f.address LIKE ?)'
      bindings.push(`%${search}%`, `%${search}%`)
    }
    if (sido) {
      whereClause += ' AND f.sido = ?'
      bindings.push(sido)
    }
    if (sigungu) {
      whereClause += ' AND f.sigungu = ?'
      bindings.push(sigungu)
    }
    if (type) {
      whereClause += ' AND f.facility_type = ?'
      bindings.push(type)
    }
    
    // 대표센터 필터 적용
    let joinClause = ''
    let additionalWhere = ''
    
    if (isRegionalCenter === 'true') {
      // 대표센터만 조회
      joinClause = ' INNER JOIN regional_centers rc ON f.id = rc.facility_id'
    } else if (isRegionalCenter === 'false') {
      // 일반시설만 조회 (대표센터 제외)
      joinClause = ' LEFT JOIN regional_centers rc ON f.id = rc.facility_id'
      additionalWhere = ' AND rc.facility_id IS NULL'
    }
    
    // 총 개수
    const countResult = await DB.prepare(
      `SELECT COUNT(*) as total FROM facilities f${joinClause} WHERE ${whereClause}${additionalWhere}`
    ).bind(...bindings).first()
    
    // 데이터 조회
    const facilitiesResult = await DB.prepare(
      `SELECT f.* FROM facilities f${joinClause} WHERE ${whereClause}${additionalWhere} ORDER BY f.id DESC LIMIT ? OFFSET ?`
    ).bind(...bindings, limit, offset).all()
    
    // 한 번의 쿼리로 모든 대표센터 정보 가져오기 (성능 최적화)
    const facilityIds = facilitiesResult.results.map((f: any) => f.id)
    let regionalCenterIds: Set<number> = new Set()
    
    if (facilityIds.length > 0) {
      // IN 절을 사용하여 한 번에 조회
      const placeholders = facilityIds.map(() => '?').join(',')
      const regionalCentersResult = await DB.prepare(
        `SELECT DISTINCT facility_id FROM regional_centers WHERE facility_id IN (${placeholders})`
      ).bind(...facilityIds).all()
      
      regionalCenterIds = new Set(
        regionalCentersResult.results.map((rc: any) => rc.facility_id)
      )
    }
    
    // 대표센터 여부를 추가하여 반환
    const facilities = facilitiesResult.results.map((facility: any) => ({
      ...facility,
      is_regional_center: regionalCenterIds.has(facility.id)
    }))
    
    return c.json({
      success: true,
      facilities,
      total: countResult?.total || 0,
      page,
      limit,
      totalPages: Math.ceil((countResult?.total || 0) / limit)
    })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 상세 조회
app.get('/api/admin/facilities/:id', async (c) => {
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    
    const facility = await DB.prepare(
      'SELECT * FROM facilities WHERE id = ?'
    ).bind(id).first()
    
    if (!facility) {
      return c.json({ success: false, error: '시설을 찾을 수 없습니다' }, 404)
    }
    
    return c.json({ success: true, facility })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 정보 수정
app.put('/api/admin/facilities/:id', async (c) => {
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    const data = await c.req.json()
    
    await DB.prepare(`
      UPDATE facilities SET
        facility_type = ?,
        name = ?,
        postal_code = ?,
        address = ?,
        phone = ?,
        latitude = ?,
        longitude = ?,
        sido = ?,
        sigungu = ?,
        updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      data.facility_type,
      data.name,
      data.postal_code || '',
      data.address,
      data.phone || '',
      data.latitude,
      data.longitude,
      data.sido,
      data.sigungu,
      id
    ).run()
    
    return c.json({ success: true, message: '시설 정보가 수정되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 삭제
app.delete('/api/admin/facilities/:id', async (c) => {
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    
    // 대표센터로 지정된 경우 regional_centers에서도 제거
    await DB.prepare('DELETE FROM regional_centers WHERE facility_id = ?').bind(id).run()
    
    await DB.prepare('DELETE FROM facilities WHERE id = ?').bind(id).run()
    
    return c.json({ success: true, message: '시설이 삭제되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 대표 상담센터 지정/해제
app.post('/api/admin/facilities/toggle-regional-center', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const { facilityId, regionKey, isRegionalCenter } = await c.req.json()
    
    // 시설 정보 조회
    const facility: any = await DB.prepare(
      'SELECT * FROM facilities WHERE id = ?'
    ).bind(facilityId).first()
    
    if (!facility) {
      return c.json({ success: false, message: '시설을 찾을 수 없습니다.' }, 404)
    }
    
    if (isRegionalCenter) {
      // 대표센터로 지정
      
      // 해당 지역의 대표 상담센터 개수 확인
      const countResult = await DB.prepare(
        'SELECT COUNT(*) as count FROM regional_centers WHERE region_key = ?'
      ).bind(regionKey).first()
      
      if (countResult && (countResult.count as number) >= 4) {
        return c.json({ 
          success: false, 
          message: '해당 지역은 이미 4개의 대표 상담센터가 등록되어 있습니다. 다른 센터를 제거한 후 추가해주세요.' 
        })
      }
      
      // 중복 체크
      const existsResult = await DB.prepare(
        'SELECT id FROM regional_centers WHERE region_key = ? AND facility_id = ?'
      ).bind(regionKey, facilityId).first()
      
      if (existsResult) {
        return c.json({ success: false, message: '이미 대표센터로 지정되어 있습니다.' })
      }
      
      // Regional centers 테이블에 추가
      const rcId = 'rc_facility_' + Date.now() + '_' + Math.random().toString(36).substring(2)
      await DB.prepare(`
        INSERT INTO regional_centers (
          id, region_key, partner_id, facility_id, facility_name, facility_type, 
          manager_name, manager_phone, created_at
        ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(
        rcId,
        regionKey,
        'facility_' + facilityId, // partner_id를 facility ID로 대체
        facilityId, // facility_id 추가
        facility.name,
        facility.facility_type,
        '', // manager_name (facilities에는 없음)
        facility.phone || '연락처 없음',
        new Date().toISOString()
      ).run()
      
      return c.json({ success: true, message: '대표 상담센터로 지정되었습니다.' })
    } else {
      // 대표센터 해제
      await DB.prepare(
        'DELETE FROM regional_centers WHERE region_key = ? AND facility_id = ?'
      ).bind(regionKey, facilityId).run()
      
      return c.json({ success: true, message: '대표 상담센터에서 해제되었습니다.' })
    }
  } catch (error) {
    console.error('Toggle regional center error:', error)
    return c.json({ success: false, message: '설정 실패' }, 500)
  }
})

// 엑셀 업로드 (시설 정보 업데이트 및 추가)
app.post('/api/admin/upload-facilities', async (c) => {
  try {
    const { facilities } = await c.req.json()
    const { DB } = c.env
    
    if (!Array.isArray(facilities) || facilities.length === 0) {
      return c.json({ success: false, error: '유효한 시설 데이터가 없습니다' }, 400)
    }
    
    console.log(`📤 엑셀 업로드 시작: ${facilities.length}개`)
    
    let updated = 0
    let inserted = 0
    let failed = 0
    
    // 500개씩 배치 처리
    for (let i = 0; i < facilities.length; i += 500) {
      const batch = facilities.slice(i, i + 500)
      
      for (const facility of batch) {
        try {
          if (facility.id) {
            // ID가 있으면 UPDATE
            const result = await DB.prepare(`
              UPDATE facilities 
              SET facility_type = ?, name = ?, postal_code = ?, address = ?, phone = ?, 
                  latitude = ?, longitude = ?, sido = ?, sigungu = ?, notes = ?,
                  updated_at = CURRENT_TIMESTAMP
              WHERE id = ?
            `).bind(
              facility.facility_type,
              facility.name,
              facility.postal_code || '',
              facility.address,
              facility.phone || '',
              facility.latitude || 0,
              facility.longitude || 0,
              facility.sido,
              facility.sigungu,
              facility.notes || '',
              facility.id
            ).run()
            
            if (result.meta.changes > 0) {
              updated++
            } else {
              // ID가 있지만 DB에 없으면 INSERT
              await DB.prepare(`
                INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu, notes)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
              `).bind(
                facility.facility_type,
                facility.name,
                facility.postal_code || '',
                facility.address,
                facility.phone || '',
                facility.latitude || 0,
                facility.longitude || 0,
                facility.sido,
                facility.sigungu,
                facility.notes || ''
              ).run()
              inserted++
            }
          } else {
            // ID가 없으면 INSERT (신규 추가)
            await DB.prepare(`
              INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu, notes)
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `).bind(
              facility.facility_type,
              facility.name,
              facility.postal_code || '',
              facility.address,
              facility.phone || '',
              facility.latitude || 0,
              facility.longitude || 0,
              facility.sido,
              facility.sigungu,
              facility.notes || ''
            ).run()
            inserted++
          }
        } catch (err) {
          console.error('Facility update/insert error:', err)
          failed++
        }
      }
      
      console.log(`📦 Batch ${Math.floor(i/500) + 1}: 업데이트=${updated}, 신규=${inserted}, 실패=${failed}`)
    }
    
    console.log(`✅ 업로드 완료: 업데이트=${updated}, 신규=${inserted}, 실패=${failed}`)
    return c.json({ success: true, updated, inserted, failed, total: facilities.length })
  } catch (error: any) {
    console.error('Upload facilities error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 요양병원 데이터 교체 (기존 삭제 후 새 데이터 삽입)
app.post('/api/admin/replace-hospitals', async (c) => {
  try {
    const { hospitals } = await c.req.json()
    const { DB } = c.env
    
    if (!Array.isArray(hospitals) || hospitals.length === 0) {
      return c.json({ success: false, error: '유효한 병원 데이터가 없습니다' }, 400)
    }
    
    console.log(`🏥 요양병원 데이터 교체 시작: ${hospitals.length}개`)
    
    // 1. 기존 요양병원 데이터 모두 삭제
    const deleteResult = await DB.prepare(
      "DELETE FROM facilities WHERE facility_type = '요양병원'"
    ).run()
    console.log(`✅ 기존 요양병원 삭제 완료: ${deleteResult.meta.changes}개`)
    
    // 2. 새 요양병원 데이터 삽입 (D1 batch API 사용, 500개씩)
    let imported = 0
    let failed = 0
    
    for (let i = 0; i < hospitals.length; i += 500) {
      const batch = hospitals.slice(i, i + 500)
      const statements = []
      
      for (const hospital of batch) {
        try {
          statements.push(
            DB.prepare(`
              INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu, notes)
              VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            `).bind(
              '요양병원',
              hospital.name,
              '',  // postal_code (엑셀에 없음)
              hospital.address,
              hospital.phone || '',
              0.0,  // latitude (기본값, 나중에 지오코딩 필요)
              0.0,  // longitude (기본값, 나중에 지오코딩 필요)
              hospital.sido,
              hospital.sigungu,
              hospital.notes || ''
            )
          )
        } catch (err) {
          console.error('Prepare error:', err)
          failed++
        }
      }
      
      // 배치 실행
      try {
        await DB.batch(statements)
        imported += statements.length
        console.log(`📦 Batch ${Math.floor(i/500) + 1}: ${statements.length}개 삽입 (총: ${imported}개)`)
      } catch (err) {
        console.error('Batch import error:', err)
        failed += statements.length
      }
    }
    
    console.log(`🎉 교체 완료: ${imported}개 성공, ${failed}개 실패`)
    return c.json({ 
      success: true, 
      deleted: deleteResult.meta.changes,
      imported, 
      failed, 
      total: hospitals.length 
    })
  } catch (error: any) {
    console.error('Replace hospitals error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// 시설 추가
app.post('/api/admin/facilities', async (c) => {
  try {
    const { DB } = c.env
    const data = await c.req.json()
    
    const result = await DB.prepare(`
      INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.facility_type,
      data.name,
      data.postal_code || '',
      data.address,
      data.phone || '',
      data.latitude,
      data.longitude,
      data.sido,
      data.sigungu
    ).run()
    
    return c.json({ success: true, id: result.meta.last_row_id, message: '시설이 추가되었습니다' })
  } catch (error: any) {
    return c.json({ success: false, error: error.message }, 500)
  }
})

// D1에서 시설 데이터 조회 (메인 검색 페이지용)
app.get('/api/facilities-from-db', async (c) => {
  try {
    const { DB } = c.env
    const sido = c.req.query('sido') || ''
    const sigungu = c.req.query('sigungu') || ''
    const type = c.req.query('type') || ''
    const keyword = c.req.query('keyword') || ''
    
    let whereClause = '1=1'
    const bindings: any[] = []
    
    if (sido) {
      whereClause += ' AND sido = ?'
      bindings.push(sido)
    }
    if (sigungu) {
      whereClause += ' AND sigungu = ?'
      bindings.push(sigungu)
    }
    if (type) {
      whereClause += ' AND facility_type = ?'
      bindings.push(type)
    }
    if (keyword) {
      whereClause += ' AND name LIKE ?'
      bindings.push(`%${keyword}%`)
    }
    
    const result = await DB.prepare(
      `SELECT * FROM facilities WHERE ${whereClause}`
    ).bind(...bindings).all()
    
    return c.json({ success: true, facilities: result.results })
  } catch (error: any) {
    console.error('DB query error:', error)
    return c.json({ success: false, error: error.message }, 500)
  }
})

// ============================================
// 시설 관리 API
// ============================================

// 시설 목록 조회 (페이지네이션)
app.get('/api/admin/facilities', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const page = parseInt(c.req.query('page') || '1')
    const limit = parseInt(c.req.query('limit') || '50')
    const search = c.req.query('search') || ''
    const sido = c.req.query('sido') || ''
    const sigungu = c.req.query('sigungu') || ''
    const type = c.req.query('type') || ''
    
    let whereClause = '1=1'
    const bindings: any[] = []
    
    if (search) {
      whereClause += ' AND (name LIKE ? OR address LIKE ?)'
      bindings.push(`%${search}%`, `%${search}%`)
    }
    if (sido) {
      whereClause += ' AND sido = ?'
      bindings.push(sido)
    }
    if (sigungu) {
      whereClause += ' AND sigungu = ?'
      bindings.push(sigungu)
    }
    if (type) {
      whereClause += ' AND facility_type = ?'
      bindings.push(type)
    }
    
    // 전체 개수 조회
    const countResult = await DB.prepare(
      `SELECT COUNT(*) as total FROM facilities WHERE ${whereClause}`
    ).bind(...bindings).first()
    
    const total = countResult?.total || 0
    const totalPages = Math.ceil(total / limit)
    const offset = (page - 1) * limit
    
    // 데이터 조회
    const result = await DB.prepare(
      `SELECT * FROM facilities WHERE ${whereClause} ORDER BY id DESC LIMIT ? OFFSET ?`
    ).bind(...bindings, limit, offset).all()
    
    return c.json({
      facilities: result.results,
      total,
      page,
      totalPages,
      limit
    })
  } catch (error: any) {
    console.error('Facilities fetch error:', error)
    return c.json({ error: error.message }, 500)
  }
})

// DB 초기화 (모든 시설 삭제)
app.post('/api/admin/init-db', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    
    // 모든 시설 삭제
    await DB.prepare('DELETE FROM facilities').run()
    
    return c.json({ 
      success: true, 
      message: '모든 시설 정보가 삭제되었습니다.' 
    })
  } catch (error: any) {
    console.error('DB init error:', error)
    return c.json({ 
      success: false, 
      message: '초기화 실패: ' + error.message 
    }, 500)
  }
})

// CSV 임포트 (배치 처리)
app.post('/api/admin/import-csv', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const { facilities } = await c.req.json()
    
    if (!facilities || !Array.isArray(facilities)) {
      return c.json({ 
        success: false, 
        message: '잘못된 데이터 형식입니다.' 
      }, 400)
    }
    
    // 배치 처리 (100개씩)
    const BATCH_SIZE = 100
    let successCount = 0
    let errorCount = 0
    
    for (let i = 0; i < facilities.length; i += BATCH_SIZE) {
      const batch = facilities.slice(i, i + BATCH_SIZE)
      
      try {
        const values = batch.map((f: any) => {
          return `('${f.facility_type.replace(/'/g, "''")}', '${f.name.replace(/'/g, "''")}', '${f.postal_code || ''}', '${f.address.replace(/'/g, "''")}', '${f.phone || ''}', ${f.latitude || 0}, ${f.longitude || 0}, '${f.sido.replace(/'/g, "''")}', '${f.sigungu.replace(/'/g, "''")}')`
        }).join(', ')
        
        await DB.prepare(`
          INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu)
          VALUES ${values}
        `).run()
        
        successCount += batch.length
      } catch (batchError) {
        console.error('Batch error:', batchError)
        errorCount += batch.length
      }
    }
    
    return c.json({
      success: true,
      message: `임포트 완료: 성공 ${successCount}개, 실패 ${errorCount}개`,
      successCount,
      errorCount
    })
  } catch (error: any) {
    console.error('CSV import error:', error)
    return c.json({ 
      success: false, 
      message: '임포트 실패: ' + error.message 
    }, 500)
  }
})

// 시설 추가
app.post('/api/admin/facility', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const data = await c.req.json()
    
    await DB.prepare(`
      INSERT INTO facilities (facility_type, name, postal_code, address, phone, latitude, longitude, sido, sigungu, created_at, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      data.facility_type,
      data.name,
      data.postal_code || '',
      data.address,
      data.phone || '',
      data.latitude,
      data.longitude,
      data.sido,
      data.sigungu,
      new Date().toISOString(),
      new Date().toISOString()
    ).run()
    
    return c.json({ success: true, message: '시설이 추가되었습니다.' })
  } catch (error: any) {
    console.error('Facility add error:', error)
    return c.json({ 
      success: false, 
      message: '추가 실패: ' + error.message 
    }, 500)
  }
})

// 시설 수정
app.put('/api/admin/facility/:id', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    const data = await c.req.json()
    
    await DB.prepare(`
      UPDATE facilities 
      SET facility_type = ?, name = ?, postal_code = ?, address = ?, phone = ?, 
          latitude = ?, longitude = ?, sido = ?, sigungu = ?, updated_at = ?
      WHERE id = ?
    `).bind(
      data.facility_type,
      data.name,
      data.postal_code || '',
      data.address,
      data.phone || '',
      data.latitude,
      data.longitude,
      data.sido,
      data.sigungu,
      new Date().toISOString(),
      id
    ).run()
    
    return c.json({ success: true, message: '시설 정보가 수정되었습니다.' })
  } catch (error: any) {
    console.error('Facility update error:', error)
    return c.json({ 
      success: false, 
      message: '수정 실패: ' + error.message 
    }, 500)
  }
})

// 시설 삭제
app.delete('/api/admin/facility/:id', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    
    await DB.prepare('DELETE FROM facilities WHERE id = ?').bind(id).run()
    
    return c.json({ success: true, message: '시설이 삭제되었습니다.' })
  } catch (error: any) {
    console.error('Facility delete error:', error)
    return c.json({ 
      success: false, 
      message: '삭제 실패: ' + error.message 
    }, 500)
  }
})

// 시설 상세 조회
app.get('/api/admin/facility/:id', async (c) => {
  if (!(await isAdmin(c))) {
    return c.json({ error: 'Unauthorized' }, 401)
  }
  
  try {
    const { DB } = c.env
    const id = c.req.param('id')
    
    const facility = await DB.prepare(
      'SELECT * FROM facilities WHERE id = ?'
    ).bind(id).first()
    
    if (!facility) {
      return c.json({ error: '시설을 찾을 수 없습니다.' }, 404)
    }
    
    return c.json({ facility })
  } catch (error: any) {
    console.error('Facility fetch error:', error)
    return c.json({ error: error.message }, 500)
  }
})

export default app
